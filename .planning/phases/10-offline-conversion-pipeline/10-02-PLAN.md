---
phase: 10-offline-conversion-pipeline
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/conversions/google-ads.ts
autonomous: true
requirements:
  - OFL-06
  - OFL-08
  - OFL-09
user_setup:
  - service: google_ads_api
    why: "OAuth2 credentials for Google Ads API offline conversion upload"
    env_vars:
      - name: GOOGLE_ADS_CLIENT_ID
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client ID"
      - name: GOOGLE_ADS_CLIENT_SECRET
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client Secret"
      - name: GOOGLE_ADS_REFRESH_TOKEN
        source: "Generated via OAuth2 consent flow (one-time) with scope: https://www.googleapis.com/auth/adwords"
      - name: GOOGLE_ADS_DEVELOPER_TOKEN
        source: "Google Ads API Center (already approved)"
      - name: GOOGLE_ADS_CUSTOMER_ID
        source: "Google Ads dashboard — 215-246-8876 (without dashes: 2152468876)"
      - name: GOOGLE_ADS_LOGIN_CUSTOMER_ID
        source: "Google Ads Manager account — 670-646-4060 (without dashes: 6706464060)"

must_haves:
  truths:
    - "A function uploadConversion() sends a properly formatted request to the Google Ads uploadClickConversions REST endpoint"
    - "The upload payload includes both gclid and sha256_email_address as userIdentifiers for maximum match rate (OFL-08)"
    - "The upload payload includes consent signals ad_user_data: GRANTED and ad_personalization: GRANTED (OFL-09)"
    - "OAuth2 access token is obtained from refresh token and cached until expiry; a new token is fetched when the cached one expires"
    - "The function returns a structured result indicating success (with partial_failure details) or failure (with error message)"
  artifacts:
    - path: "src/lib/conversions/google-ads.ts"
      provides: "uploadConversion() function, OAuth2 token management, Google Ads REST API integration"
      contains: "uploadConversion"
  key_links:
    - from: "src/lib/conversions/google-ads.ts"
      to: "Google Ads API v18 uploadClickConversions"
      via: "REST POST to googleads.googleapis.com"
      pattern: "googleads.googleapis.com"
    - from: "src/lib/conversions/google-ads.ts"
      to: "Google OAuth2 token endpoint"
      via: "POST to oauth2.googleapis.com/token with refresh_token grant"
      pattern: "oauth2.googleapis.com"
---

<objective>
Build the Google Ads API upload module that formats conversion data and sends it to the Google Ads uploadClickConversions REST endpoint with OAuth2 authentication.

Purpose: This standalone module encapsulates all Google Ads API interaction — token refresh, payload formatting (gclid + email userIdentifiers, consent signals), and error handling. It is consumed by the queue processor (Plan 03) but has no dependency on the webhook (Plan 01), enabling parallel development.
Output: 1 file — self-contained Google Ads upload module.
</objective>

<execution_context>
@/Users/szymonwilkosz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/szymonwilkosz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@supabase/migrations/002_conversions.sql
@supabase/migrations/003_conversion_queue.sql

Key facts:
- Google Ads API Developer Token: approved (from PROJECT.md)
- Customer ID: 215-246-8876 (env var: GOOGLE_ADS_CUSTOMER_ID, no dashes)
- Manager account: 670-646-4060 (env var: GOOGLE_ADS_LOGIN_CUSTOMER_ID, no dashes)
- Google Ads API version: v18 (current stable as of 2026)
- REST endpoint: POST https://googleads.googleapis.com/v18/customers/{customer_id}:uploadClickConversions
- OAuth2 token endpoint: https://oauth2.googleapis.com/token
- Token refresh uses: client_id, client_secret, refresh_token, grant_type=refresh_token
- Access tokens expire in ~3600 seconds — cache and refresh proactively
- Conversion action name format: customers/{customer_id}/conversionActions/{action_id}
- Conversion action IDs will be configured as env vars (different for qualified vs closed)
- EEA users require consent signals: ad_user_data GRANTED, ad_personalization GRANTED (OFL-09)
- Both gclid and sha256_email_address should be sent as userIdentifiers (OFL-08)
- API uses partial_failure_error field in response for per-conversion error reporting
- Node.js fetch is available natively (Next.js 16 / Node 20+)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Google Ads upload module with OAuth2 and conversion formatting</name>
  <files>src/lib/conversions/google-ads.ts</files>
  <action>
Create `src/lib/conversions/google-ads.ts`:

```typescript
/**
 * Google Ads API Offline Conversion Upload
 *
 * Uploads offline conversions (qualified leads, closed deals) to Google Ads
 * via the REST uploadClickConversions endpoint. Uses OAuth2 with refresh token
 * for authentication.
 *
 * Supports both gclid-based click attribution and Enhanced Conversions for Leads
 * (sha256 email hash) as userIdentifiers for maximum match rate (OFL-08).
 *
 * Includes EEA consent signals as required by Google (OFL-09).
 *
 * Reference: https://developers.google.com/google-ads/api/rest/reference/rest/v18/customers/uploadClickConversions
 */

// --- Configuration ---

const GOOGLE_ADS_API_VERSION = "v18";
const TOKEN_ENDPOINT = "https://oauth2.googleapis.com/token";

function getGoogleAdsEndpoint(customerId: string): string {
  return `https://googleads.googleapis.com/${GOOGLE_ADS_API_VERSION}/customers/${customerId}:uploadClickConversions`;
}

// --- Types ---

interface ConversionData {
  /** Google click ID from the original ad click */
  gclid: string | null;
  /** SHA-256 hex hash of the normalized email (lowercase, trimmed) */
  email_hash: string | null;
  /** Type of conversion: qualified or closed */
  conversion_type: "qualified" | "closed";
  /** Monetary value of the conversion (nullable) */
  conversion_value: number | null;
  /** Currency code (defaults to EUR) */
  conversion_currency: string;
  /** When the conversion occurred (ISO 8601 timestamp) */
  conversion_time: string;
}

interface UploadResult {
  success: boolean;
  /** Error message if upload failed */
  error?: string;
  /** Partial failure details from Google Ads API */
  partial_failure_error?: string;
}

// --- OAuth2 Token Management ---

let cachedToken: { access_token: string; expires_at: number } | null = null;

/**
 * Get a valid OAuth2 access token, refreshing if necessary.
 *
 * Caches the token in-memory with a 5-minute buffer before expiry.
 * On Vercel serverless, cache lives per function instance (acceptable
 * since token refresh is cheap and instances are short-lived).
 */
async function getAccessToken(): Promise<string> {
  const now = Date.now();

  // Return cached token if still valid (with 5 min buffer)
  if (cachedToken && cachedToken.expires_at > now + 5 * 60 * 1000) {
    return cachedToken.access_token;
  }

  const clientId = process.env.GOOGLE_ADS_CLIENT_ID;
  const clientSecret = process.env.GOOGLE_ADS_CLIENT_SECRET;
  const refreshToken = process.env.GOOGLE_ADS_REFRESH_TOKEN;

  if (!clientId || !clientSecret || !refreshToken) {
    throw new Error("Google Ads OAuth2 credentials not configured");
  }

  const response = await fetch(TOKEN_ENDPOINT, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: new URLSearchParams({
      client_id: clientId,
      client_secret: clientSecret,
      refresh_token: refreshToken,
      grant_type: "refresh_token",
    }),
  });

  if (!response.ok) {
    const errorBody = await response.text();
    throw new Error(`OAuth2 token refresh failed (${response.status}): ${errorBody}`);
  }

  const tokenData = (await response.json()) as {
    access_token: string;
    expires_in: number;
  };

  cachedToken = {
    access_token: tokenData.access_token,
    expires_at: now + tokenData.expires_in * 1000,
  };

  return cachedToken.access_token;
}

// --- Conversion Action Mapping ---

/**
 * Get the full resource name for a conversion action.
 *
 * Maps conversion_type to the corresponding Google Ads conversion action ID.
 * Conversion actions must be created in the Google Ads dashboard first,
 * then their IDs configured in env vars.
 *
 * Format: customers/{customer_id}/conversionActions/{action_id}
 */
function getConversionActionName(
  customerId: string,
  conversionType: "qualified" | "closed"
): string {
  const envKey =
    conversionType === "qualified"
      ? "GOOGLE_ADS_CONVERSION_ACTION_QUALIFIED"
      : "GOOGLE_ADS_CONVERSION_ACTION_CLOSED";

  const actionId = process.env[envKey];
  if (!actionId) {
    throw new Error(`${envKey} not configured`);
  }

  return `customers/${customerId}/conversionActions/${actionId}`;
}

// --- Payload Builder ---

/**
 * Build the Google Ads uploadClickConversions request body.
 *
 * Includes:
 * - gclid for click attribution (when available)
 * - sha256_email_address as userIdentifier for Enhanced Conversions (OFL-08)
 * - Consent signals for EEA compliance (OFL-09)
 * - Conversion value and currency
 */
function buildUploadPayload(
  customerId: string,
  conversion: ConversionData
): Record<string, unknown> {
  const conversionAction = getConversionActionName(
    customerId,
    conversion.conversion_type
  );

  // Build userIdentifiers array (OFL-08)
  const userIdentifiers: Array<Record<string, unknown>> = [];

  if (conversion.email_hash) {
    userIdentifiers.push({
      hashedEmail: conversion.email_hash,
    });
  }

  // Build the click conversion object
  const clickConversion: Record<string, unknown> = {
    conversionAction,
    conversionDateTime: conversion.conversion_time,
    // OFL-09: Consent signals required for EEA users
    consent: {
      adUserData: "GRANTED",
      adPersonalization: "GRANTED",
    },
  };

  // Add gclid if available (primary attribution)
  if (conversion.gclid) {
    clickConversion.gclid = conversion.gclid;
  }

  // Add user identifiers for Enhanced Conversions (OFL-08)
  if (userIdentifiers.length > 0) {
    clickConversion.userIdentifiers = userIdentifiers;
  }

  // Add conversion value if present
  if (conversion.conversion_value !== null) {
    clickConversion.conversionValue = conversion.conversion_value;
    clickConversion.currencyCode = conversion.conversion_currency;
  }

  return {
    conversions: [clickConversion],
    // Enable partial failure reporting (returns per-conversion errors)
    partialFailure: true,
  };
}

// --- Upload Function ---

/**
 * Upload a single offline conversion to Google Ads API (OFL-06).
 *
 * Handles OAuth2 token refresh, payload formatting, and error parsing.
 * Returns a structured result indicating success or failure.
 *
 * Called by the queue processor (Plan 03) for each pending/retry-ready item.
 */
export async function uploadConversion(
  conversion: ConversionData
): Promise<UploadResult> {
  const customerId = process.env.GOOGLE_ADS_CUSTOMER_ID;
  const loginCustomerId = process.env.GOOGLE_ADS_LOGIN_CUSTOMER_ID;
  const developerToken = process.env.GOOGLE_ADS_DEVELOPER_TOKEN;

  if (!customerId || !loginCustomerId || !developerToken) {
    return {
      success: false,
      error: "Google Ads API credentials not configured",
    };
  }

  // Validate we have at least one identifier
  if (!conversion.gclid && !conversion.email_hash) {
    return {
      success: false,
      error: "No attribution data (gclid or email_hash)",
    };
  }

  try {
    const accessToken = await getAccessToken();
    const endpoint = getGoogleAdsEndpoint(customerId);
    const payload = buildUploadPayload(customerId, conversion);

    const response = await fetch(endpoint, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${accessToken}`,
        "developer-token": developerToken,
        "login-customer-id": loginCustomerId,
      },
      body: JSON.stringify(payload),
    });

    const responseBody = (await response.json()) as Record<string, unknown>;

    if (!response.ok) {
      // API-level error (auth failure, invalid request, rate limit)
      const errorDetails =
        typeof responseBody.error === "object" && responseBody.error
          ? (responseBody.error as { message?: string }).message
          : JSON.stringify(responseBody);

      return {
        success: false,
        error: `Google Ads API error (${response.status}): ${errorDetails}`,
      };
    }

    // Check for partial failure (individual conversion errors within a successful request)
    const partialFailureError = responseBody.partialFailureError as
      | { message?: string }
      | undefined;

    if (partialFailureError?.message) {
      return {
        success: false,
        error: "Partial failure",
        partial_failure_error: partialFailureError.message,
      };
    }

    return { success: true };
  } catch (err) {
    const message = err instanceof Error ? err.message : String(err);
    return { success: false, error: message };
  }
}
```

Key implementation decisions:
- Uses Google Ads REST API v18 (not client library — per PROJECT.md tech decisions)
- OAuth2 refresh token flow with in-memory caching (5-min expiry buffer)
- Both gclid and hashedEmail sent as identifiers (OFL-08) — gclid at top level, email in userIdentifiers array
- Consent signals always GRANTED (OFL-09) — consent captured at lead submission time
- partialFailure: true enables per-conversion error reporting from Google
- Conversion action IDs from env vars (different for qualified vs closed)
- New env vars: GOOGLE_ADS_CLIENT_ID, GOOGLE_ADS_CLIENT_SECRET, GOOGLE_ADS_REFRESH_TOKEN, GOOGLE_ADS_DEVELOPER_TOKEN, GOOGLE_ADS_CUSTOMER_ID, GOOGLE_ADS_LOGIN_CUSTOMER_ID, GOOGLE_ADS_CONVERSION_ACTION_QUALIFIED, GOOGLE_ADS_CONVERSION_ACTION_CLOSED
  </action>
  <verify>
Validate the module:
- Confirm uploadConversion is exported
- Confirm getAccessToken handles refresh_token grant type
- Confirm buildUploadPayload includes consent.adUserData and consent.adPersonalization
- Confirm userIdentifiers array includes hashedEmail when email_hash is present
- Confirm gclid is set at the clickConversion top level (not inside userIdentifiers)
- Confirm login-customer-id header is set (required for manager account access)
- Run: grep -c "adUserData" src/lib/conversions/google-ads.ts — expect 1
- Run: grep -c "adPersonalization" src/lib/conversions/google-ads.ts — expect 1
- Run: grep -c "hashedEmail" src/lib/conversions/google-ads.ts — expect 1
- Run: grep -c "uploadConversion" src/lib/conversions/google-ads.ts — expect 2 (export + function)
  </verify>
  <done>
google-ads.ts provides uploadConversion() with OAuth2 token management (auto-refresh), properly formatted payload with both gclid and hashedEmail userIdentifiers (OFL-08), consent signals GRANTED (OFL-09), and structured error handling. Ready for consumption by the queue processor.
  </done>
</task>

</tasks>

<verification>
1. src/lib/conversions/google-ads.ts exists with uploadConversion export
2. OAuth2 token refresh uses refresh_token grant type to oauth2.googleapis.com
3. Upload payload includes gclid at top level and hashedEmail in userIdentifiers (OFL-08)
4. Upload payload includes consent.adUserData: GRANTED and consent.adPersonalization: GRANTED (OFL-09)
5. REST endpoint uses Google Ads API v18 uploadClickConversions (OFL-06)
6. Authorization header uses Bearer token, developer-token and login-customer-id headers present
7. Partial failure errors are parsed and returned in result
8. Token caching prevents unnecessary refresh on consecutive calls
</verification>

<success_criteria>
- uploadConversion with valid credentials and gclid+email_hash returns { success: true }
- uploadConversion with missing credentials returns { success: false, error } without throwing
- Upload payload matches Google Ads REST API v18 schema
- Both gclid and email userIdentifiers included when both available
- Consent signals present in every upload payload
- OAuth2 token is cached and refreshed on expiry
</success_criteria>

<output>
After completion, create `.planning/phases/10-offline-conversion-pipeline/10-02-SUMMARY.md`
</output>

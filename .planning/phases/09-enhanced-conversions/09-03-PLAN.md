---
phase: 09-enhanced-conversions
plan: 03
type: execute
wave: 3
depends_on:
  - 09-02-PLAN.md
files_modified:
  - src/components/lp/sections/lead-form-section.tsx
  - src/components/lead-form.tsx
  - src/app/(lp)/lp/[city]/danke/conversion-tracker.tsx
autonomous: true
requirements:
  - EC-02
  - EC-04

must_haves:
  truths:
    - "On LP form submission, gtag('set', 'user_data', { email }) fires BEFORE the conversion event — verifiable by reading the fireConversionEvent function top-to-bottom"
    - "On main form submission, gtag('set', 'user_data', { email }) fires BEFORE gtag('event', 'generate_lead') — verifiable by reading the handleSubmit gtag block"
    - "A single transaction_id (UUID) is generated client-side at form submission time — the same value is sent to both gtag and the API POST body"
    - "The danke page ConversionTracker reads the stored transaction_id from sessionStorage and uses it for the conversion event instead of generating a new one (falls back to crypto.randomUUID() if unavailable)"
    - "The email passed to gtag user_data is trimmed and lowercased but NOT hashed — Google hashes it internally"
  artifacts:
    - path: "src/components/lp/sections/lead-form-section.tsx"
      provides: "LP form fires gtag user_data + sends shared transaction_id to API and gtag"
      contains: "user_data"
    - path: "src/components/lead-form.tsx"
      provides: "Main form fires gtag user_data + sends shared transaction_id to API and gtag"
      contains: "user_data"
    - path: "src/app/(lp)/lp/[city]/danke/conversion-tracker.tsx"
      provides: "Danke page reads transaction_id from sessionStorage instead of generating new UUID"
      contains: "transaction_id"
  key_links:
    - from: "src/components/lp/sections/lead-form-section.tsx"
      to: "src/app/(lp)/lp/[city]/danke/conversion-tracker.tsx"
      via: "sessionStorage stores transaction_id alongside other tracking data"
      pattern: "transaction_id"
    - from: "src/components/lp/sections/lead-form-section.tsx"
      to: "src/lib/leads/service.ts"
      via: "POST body includes transaction_id field"
      pattern: "transaction_id"
    - from: "src/components/lead-form.tsx"
      to: "src/lib/leads/service.ts"
      via: "POST body includes transaction_id field"
      pattern: "transaction_id"
---

<objective>
Wire client-side user_data email for Enhanced Conversions (EC-02) and client-side transaction_id generation for deduplication (EC-04 client half).

EC-02: Both lead forms must fire `gtag('set', 'user_data', { email })` BEFORE the conversion event on submission.
EC-04 (client): A single transaction_id (UUID) generated at submission time is shared between the gtag conversion event and the API request body. The danke page reuses the stored transaction_id from sessionStorage.
</objective>

<execution_context>
@/Users/szymonwilkosz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/szymonwilkosz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/lp/sections/lead-form-section.tsx
@src/components/lead-form.tsx
@src/app/(lp)/lp/[city]/danke/conversion-tracker.tsx
@src/lib/leads/service.ts
@src/components/lp/tracking/lp-tracking-provider.tsx

Key facts:
- The LP form (lead-form-section.tsx) calls fireConversionEvent(gclid) on success, then redirects to /lp/{city}/danke
- The main form (lead-form.tsx) fires gtag('event', 'generate_lead', ...) on success — no conversion tag
- The danke page (conversion-tracker.tsx) fires BOTH a Google Ads conversion tag AND a GA4 lp_form_complete event
- Currently, conversion-tracker.tsx generates its OWN transaction_id via crypto.randomUUID() — NOT shared with the API
- LPTrackingProvider stores tracking data in sessionStorage under key "_no_lp_tracking"
- The LP form POSTs to /api/lp-leads, the main form POSTs to /api/leads — both delegate to handleLeadSubmission
- After Plan 02, ValidatedLeadData includes transaction_id and the API accepts it
- gtag('set', 'user_data', { email }) must use the RAW email (not hashed) — Google hashes it internally
- For Google Ads Enhanced Conversions, user_data MUST be set before the conversion event fires
</context>

<tasks>

<task id="1" title="LP form: fire user_data + shared transaction_id">
<description>
Edit `src/components/lp/sections/lead-form-section.tsx`:

**1. Update fireConversionEvent to accept email and use a shared transaction_id:**

Replace the current `fireConversionEvent` function (lines 27-47) with:

```typescript
/**
 * Fire Google Ads conversion tag and GA4 custom event on successful form submission.
 *
 * Enhanced Conversions (EC-02): Sets user_data with raw email BEFORE the conversion
 * event fires, enabling cross-device and Safari-compatible conversion attribution.
 *
 * Transaction ID (EC-04): Uses a shared transaction_id that is also sent to the
 * lead API — enables deduplication between online gtag event and offline conversion upload.
 *
 * @param email - User's raw email for Enhanced Conversions user_data
 * @param transactionId - Shared UUID for deduplication (same value sent to API)
 * @param gclid - Google click ID for attribution (null if not present)
 */
function fireConversionEvent(email: string, transactionId: string, gclid: string | null) {
  if (typeof window === "undefined" || typeof window.gtag !== "function") {
    return;
  }

  // EC-02: Set user_data with raw email BEFORE conversion event.
  // Google normalizes and hashes the email internally.
  // This MUST fire before any conversion event for Enhanced Conversions to work.
  window.gtag("set", "user_data", {
    email: email.trim().toLowerCase(),
  });

  // Google Ads conversion tag — Conversion ID/Label configured in Google Ads dashboard
  // EC-04: Uses shared transactionId (same value sent to API) for dedup
  window.gtag("event", "conversion", {
    send_to: "AW-XXXXXXXXXX/XXXXXXXXXX", // placeholder — replace with real AW-CONVERSION_ID/LABEL
    value: 1.0,
    currency: "EUR",
    transaction_id: transactionId,
  });

  // GA4 custom event for funnel analysis and cross-channel reporting
  window.gtag("event", "lp_form_submit", {
    event_category: "conversion",
    event_label: "lp_lead_form",
    gclid: gclid ?? undefined,
    transaction_id: transactionId,
  });
}
```

**2. Update handleSubmit to generate and share transaction_id:**

In the `handleSubmit` function, inside the `try` block (around line 230), BEFORE the fetch call:

```typescript
// EC-04: Generate shared transaction_id for dedup between gtag and API
const transactionId = crypto.randomUUID();
```

Add `transaction_id: transactionId` to the fetch body (after `referrer`):
```typescript
transaction_id: transactionId,
```

**3. Update the fireConversionEvent call** (around line 272):
```typescript
// Before:
fireConversionEvent(searchParams.gclid ?? null);

// After:
fireConversionEvent(values.email, transactionId, searchParams.gclid ?? null);
```

**4. Store transactionId in sessionStorage for the danke page:**

After the fireConversionEvent call and before the router.push, persist the transaction_id:
```typescript
// Persist transaction_id for danke page ConversionTracker (EC-04)
try {
  const stored = sessionStorage.getItem("_no_lp_tracking");
  const tracking = stored ? JSON.parse(stored) : {};
  tracking.transaction_id = transactionId;
  sessionStorage.setItem("_no_lp_tracking", JSON.stringify(tracking));
} catch {
  // sessionStorage unavailable — danke page will generate its own ID
}
```
</description>
</task>

<task id="2" title="Main form: fire user_data + shared transaction_id">
<description>
Edit `src/components/lead-form.tsx`:

**1. In the handleSubmit function** (around line 99), add transaction_id generation BEFORE the fetch:

```typescript
// EC-04: Generate shared transaction_id for dedup between gtag and API
const transactionId = crypto.randomUUID();
```

**2. Add transaction_id to the fetch body** (after `referrer: tracking.referrer`):
```typescript
transaction_id: transactionId,
```

**3. Update the GA4 event firing** (after `setSubmitted(true)`, around line 141):

Replace the current gtag block:
```typescript
// Before:
if (typeof window !== "undefined" && typeof window.gtag === "function") {
  window.gtag("event", "generate_lead", {
    event_category: "lead",
    event_label: citySlug || "general",
    value: 1,
  });
}

// After:
if (typeof window !== "undefined" && typeof window.gtag === "function") {
  // EC-02: Set user_data with raw email for Enhanced Conversions
  window.gtag("set", "user_data", {
    email: (form.get("lead_mail") as string).trim().toLowerCase(),
  });

  // GA4 lead event with shared transaction_id (EC-04)
  window.gtag("event", "generate_lead", {
    event_category: "lead",
    event_label: citySlug || "general",
    value: 1,
    transaction_id: transactionId,
  });
}
```

Note: The main form does not redirect to a danke page — it shows an inline success message. So there is no sessionStorage persistence needed. The transaction_id is shared between the gtag event and the API call within the same function execution.
</description>
</task>

<task id="3" title="Danke page: read stored transaction_id from sessionStorage">
<description>
Edit `src/app/(lp)/lp/[city]/danke/conversion-tracker.tsx`:

**1. Read transaction_id from sessionStorage** alongside gclid (around lines 37-46):

Replace the current sessionStorage reading block:
```typescript
// Before:
let gclid: string | null = null;
try {
  const stored = sessionStorage.getItem("_no_lp_tracking");
  if (stored) {
    const parsed = JSON.parse(stored) as { gclid?: string | null };
    gclid = parsed.gclid ?? null;
  }
} catch {
  // sessionStorage unavailable — proceed without gclid
}

// After:
let gclid: string | null = null;
let transactionId: string | null = null;
try {
  const stored = sessionStorage.getItem("_no_lp_tracking");
  if (stored) {
    const parsed = JSON.parse(stored) as {
      gclid?: string | null;
      transaction_id?: string | null;
    };
    gclid = parsed.gclid ?? null;
    transactionId = parsed.transaction_id ?? null;
  }
} catch {
  // sessionStorage unavailable — proceed without gclid/transactionId
}
```

**2. Use the stored transaction_id** in the conversion event (around line 62):

Replace the conversion event:
```typescript
// Before:
window.gtag("event", "conversion", {
  send_to: `${conversionId}/${conversionLabel}`,
  value: 1.0,
  currency: "EUR",
  transaction_id: crypto.randomUUID(), // dedup key — prevents double-counting with Plan 03 tag
  gclid: gclid ?? undefined,
});

// After:
// EC-04: Reuse transaction_id from form submission (stored in sessionStorage by lead-form-section).
// Falls back to a new UUID if sessionStorage was unavailable.
const deduplicationId = transactionId ?? crypto.randomUUID();

window.gtag("event", "conversion", {
  send_to: `${conversionId}/${conversionLabel}`,
  value: 1.0,
  currency: "EUR",
  transaction_id: deduplicationId,
  gclid: gclid ?? undefined,
});
```

**3. Also add user_data email if available.** Read email from sessionStorage:

Add email to the parsed type and extraction:
```typescript
const parsed = JSON.parse(stored) as {
  gclid?: string | null;
  transaction_id?: string | null;
};
```

Note: We do NOT store raw email in sessionStorage for privacy reasons. The danke page conversion fires without user_data — the form submission event (lead-form-section.tsx) already sent user_data. Google will match using the transaction_id.

**4. Use deduplicationId in the GA4 event too** (around line 73):
```typescript
// Before:
window.gtag("event", "lp_form_complete", {
  event_category: "conversion",
  event_label: "danke_page_load",
  gclid: gclid ?? undefined,
});

// After:
window.gtag("event", "lp_form_complete", {
  event_category: "conversion",
  event_label: "danke_page_load",
  gclid: gclid ?? undefined,
  transaction_id: deduplicationId,
});
```

Update the component JSDoc to mention EC-04 (shared transaction_id for deduplication).
</description>
</task>

</tasks>

<verification>
After execution, verify:

1. **EC-02 — user_data email before conversion event:**
   - Open `src/components/lp/sections/lead-form-section.tsx` — confirm `gtag('set', 'user_data', { email })` fires BEFORE `gtag('event', 'conversion', ...)` in `fireConversionEvent`
   - Open `src/components/lead-form.tsx` — confirm `gtag('set', 'user_data', { email })` fires BEFORE `gtag('event', 'generate_lead', ...)`
   - Confirm the email is trimmed and lowercased but NOT hashed (Google hashes internally)

2. **EC-04 — shared transaction_id (client side):**
   - Confirm `crypto.randomUUID()` is called ONCE per form submission in each form component
   - Confirm the SAME transaction_id value is sent to both the gtag event AND the API fetch body
   - Open `conversion-tracker.tsx` — confirm it reads `transaction_id` from sessionStorage and uses it (falling back to crypto.randomUUID() only when unavailable)

3. **Regression check:**
   - Both forms still submit successfully to their API endpoints
   - The danke page still fires conversion events even without sessionStorage
   - All existing gtag events still fire with their original event names and categories
   - The fireConversionEvent function in lead-form-section.tsx still uses the placeholder send_to value
</verification>

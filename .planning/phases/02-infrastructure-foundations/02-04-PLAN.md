---
phase: 02-infrastructure-foundations
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/ci.yml
autonomous: true
requirements: [DEV-04]

must_haves:
  truths:
    - "A push to main triggers the CI pipeline"
    - "Lint failures block the build"
    - "Build failures block merge"
    - "CI passes on a clean codebase"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "GitHub Actions CI pipeline"
      contains: "npm run lint"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "GitHub Actions"
      via: "push trigger on main"
      pattern: "on:.*push"
---

<objective>
Create a GitHub Actions CI pipeline that runs lint and build on push to main and on pull requests.

Purpose: Catch regressions before deployment. Lint and build failures must be visible and block merges to main.

Output: `.github/workflows/ci.yml`
</objective>

<execution_context>
@/Users/szymonwilkosz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/szymonwilkosz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@package.json

<interfaces>
<!-- Available npm scripts -->
From package.json:
```json
{
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  }
}
```

<!-- TypeScript check is available via npx -->
Additional checks: `npx tsc --noEmit` (type checking)

<!-- Node version requirement -->
Node.js 18.17+ or 20+ (from Next.js 16 requirements)
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub Actions CI workflow</name>
  <files>.github/workflows/ci.yml</files>
  <action>
Create `.github/workflows/ci.yml`:

```yaml
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint-and-build:
    name: Lint & Build
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Type check
        run: npx tsc --noEmit

      - name: Build
        run: npm run build
        env:
          # Provide dummy env vars so build succeeds in CI
          # (Next.js needs these at build time for NEXT_PUBLIC_ vars)
          NEXT_PUBLIC_SUPABASE_URL: https://placeholder.supabase.co
          SUPABASE_SERVICE_ROLE_KEY: placeholder-key-for-ci-build
          RESEND_API_KEY: re_placeholder
          NOTIFICATION_EMAIL: ci@placeholder.test
          NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN: pk.placeholder
          NEXT_PUBLIC_GA4_ID: G-PLACEHOLDER
          NEXT_PUBLIC_GOOGLE_ADS_ID: AW-PLACEHOLDER
          NEXT_PUBLIC_GOOGLE_ADS_CONVERSION_ID: AW-PLACEHOLDER
          NEXT_PUBLIC_GOOGLE_ADS_CONVERSION_LABEL: PLACEHOLDER
```

**Key design decisions:**

1. **Single job** (lint-and-build) rather than separate jobs. For a small codebase (~30 files), the overhead of spinning up separate runners outweighs parallelization benefit. Lint takes <10s, type check <15s, build <60s.

2. **concurrency group** cancels in-progress runs when a new push arrives to the same branch. Prevents wasted CI minutes on superseded commits.

3. **Dummy env vars** for build step: Next.js bakes `NEXT_PUBLIC_*` vars into the client bundle at build time. Without them, build may fail or produce empty strings. These placeholders are never deployed — they only exist for the CI build to compile successfully.

4. **timeout-minutes: 10** prevents runaway builds from consuming unlimited minutes.

5. **npm ci** (not npm install) for deterministic installs from lockfile.

6. **Type check** (`npx tsc --noEmit`) runs separately from lint because ESLint's TypeScript config does NOT catch all type errors. This ensures full type safety.

7. The workflow runs on both push to main (catches direct pushes) and PRs targeting main (blocks merge if failing).

**Note on Sentry:** If Sentry source map upload is configured (SENTRY_AUTH_TOKEN, SENTRY_ORG, SENTRY_PROJECT), the build step will attempt to upload. In CI without those vars, Sentry SDK silently skips upload (the `silent: !process.env.CI` setting logs it). To enable source map upload in CI, add those secrets to GitHub repo settings later.
  </action>
  <verify>
    <automated>cd "/Users/szymonwilkosz/Library/Mobile Documents/com~apple~CloudDocs/claude-config/projects/next-office" && test -f .github/workflows/ci.yml && grep -c "npm run lint" .github/workflows/ci.yml && grep -c "npm run build" .github/workflows/ci.yml && grep -c "tsc --noEmit" .github/workflows/ci.yml</automated>
  </verify>
  <done>.github/workflows/ci.yml exists with lint, type check, and build steps. Triggers on push to main and PRs. Uses Node 20 with npm cache.</done>
</task>

</tasks>

<verification>
1. `cat .github/workflows/ci.yml` — complete workflow with lint + type check + build
2. YAML is valid (no syntax errors)
3. Triggers on both push and pull_request to main
4. Build step has placeholder env vars for NEXT_PUBLIC_* variables
</verification>

<success_criteria>
- .github/workflows/ci.yml exists at correct path
- Pipeline triggers on push to main and pull requests to main
- Lint step runs `npm run lint`
- Type check step runs `npx tsc --noEmit`
- Build step runs `npm run build` with placeholder env vars
- Concurrency group prevents duplicate runs
- Node.js 20 with npm cache configured
</success_criteria>

<output>
After completion, create `.planning/phases/02-infrastructure-foundations/02-04-SUMMARY.md`
</output>

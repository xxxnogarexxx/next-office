---
phase: 05-ux-and-reliability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/not-found.tsx
  - src/app/(main)/error.tsx
  - src/app/(main)/[city]/page.tsx
  - src/app/(main)/datenschutz/page.tsx
  - src/components/search-listings-client.tsx
  - src/components/city-listings-client.tsx
autonomous: true
requirements: [UX-01, UX-02, UX-03, UX-05, UX-10]

must_haves:
  truths:
    - "Navigating to /nonexistent-page shows a branded 404 page with a link back to the homepage"
    - "Navigating to /asdfgh (invalid city slug) returns a 404 page, not a page showing 'Büro mieten in asdfgh' with all listings"
    - "A runtime error in a main-site page shows a branded error boundary with a retry button, not a blank screen"
    - "The Datenschutz page section 6 references Mapbox, not OpenStreetMap"
    - "Searching or navigating to a city with zero results shows a friendly empty state with a CTA, not a blank grid"
  artifacts:
    - path: "src/app/not-found.tsx"
      provides: "Branded 404 page"
      contains: "NextOffice"
    - path: "src/app/(main)/error.tsx"
      provides: "Main layout error boundary"
      contains: "use client"
    - path: "src/app/(main)/[city]/page.tsx"
      provides: "notFound() call for invalid city slugs"
      contains: "notFound"
    - path: "src/app/(main)/datenschutz/page.tsx"
      provides: "Correct Mapbox reference in privacy policy"
      contains: "Mapbox"
    - path: "src/components/search-listings-client.tsx"
      provides: "Empty state UI when zero listings"
    - path: "src/components/city-listings-client.tsx"
      provides: "Empty state UI when zero listings for city"
  key_links:
    - from: "src/app/(main)/[city]/page.tsx"
      to: "src/app/not-found.tsx"
      via: "notFound() trigger → Next.js renders not-found.tsx"
      pattern: "notFound\\(\\)"
---

<objective>
Create branded error and 404 pages, fix invalid city slug routing, correct the Datenschutz privacy policy, and add empty-state UX for zero-result searches.

Purpose: Users should never see blank pages, generic Next.js errors, or incorrect information. Every dead-end must guide users back to useful content.

Output: 4 new/modified files handling error states, 2 files with empty-state UI, 1 privacy page fix.
</objective>

<execution_context>
@/Users/szymonwilkosz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/szymonwilkosz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

<interfaces>
<!-- Key types and contracts the executor needs. -->

From src/lib/cities.ts:
```typescript
export function getCityBySlug(slug: string): City | undefined;
export const cities: City[];
```

From src/lib/listings.ts:
```typescript
export function getCardListingsByCity(citySlug: string): ListingCardType[];
export const cardListings: ListingCardType[];
```

From src/app/(main)/[city]/page.tsx (current behavior):
```typescript
// Currently shows all listings for invalid slugs:
const cityListings = getCardListingsByCity(citySlug);
const displayListings = cityListings.length > 0 ? cityListings : cardListings;
// This means /asdfgh shows ALL listings — should be a 404 instead
```

From src/app/global-error.tsx (existing — inline styles, Sentry):
```typescript
// Root-level error boundary already exists with Sentry.captureException
// Uses inline styles because it renders outside layout tree
// Phase 5 adds src/app/(main)/error.tsx for main-layout-level errors (can use Tailwind)
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create branded 404 page and main-layout error boundary</name>
  <files>src/app/not-found.tsx, src/app/(main)/error.tsx</files>
  <action>
**1. Create `src/app/not-found.tsx`** — Next.js app-router not-found page (server component, no "use client"):
- Full-width centered layout with the NextOffice brand name at top (plain text like footer: `<span>Next</span><span class="font-bold">Office</span>`)
- Large "404" heading
- German subtitle: "Seite nicht gefunden"
- Body text: "Die angeforderte Seite existiert nicht oder wurde verschoben."
- Primary CTA button linking to "/" with text "Zur Startseite"
- Secondary text link to "/search" with text "Alle Büros durchsuchen"
- Use Tailwind classes (this renders inside the root layout where CSS is loaded)
- Import Link from "next/link" for navigation
- lang="de" is already on html element from root layout

**2. Create `src/app/(main)/error.tsx`** — Main layout error boundary ("use client" required by Next.js):
- Import `* as Sentry from "@sentry/nextjs"` and `useEffect` from React
- `useEffect(() => { Sentry.captureException(error); }, [error]);`
- Centered layout with:
  - Heading: "Ein Fehler ist aufgetreten"
  - Subtitle: "Bitte versuchen Sie es erneut oder kontaktieren Sie uns."
  - "Erneut versuchen" button calling `reset()` — use Tailwind classes: `rounded-lg bg-foreground px-6 py-3 text-sm font-medium text-white hover:bg-foreground/90`
  - Link to "/" with text "Zur Startseite"
- Uses Tailwind (renders inside main layout where CSS is available — unlike global-error.tsx which uses inline styles)
  </action>
  <verify>
Verify both files exist and have correct structure:
```bash
test -f src/app/not-found.tsx && grep -q "404" src/app/not-found.tsx && grep -q "Startseite" src/app/not-found.tsx && echo "not-found.tsx OK"
test -f src/app/(main)/error.tsx && grep -q "use client" src/app/(main)/error.tsx && grep -q "captureException" src/app/(main)/error.tsx && echo "error.tsx OK"
npx tsc --noEmit
```
  </verify>
  <done>
- /nonexistent-page shows branded 404 with "Zur Startseite" link (UX-01)
- Runtime errors in main-site pages show error boundary with retry button and Sentry reporting (UX-02)
- TypeScript compiles with zero errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix invalid city slug routing, Datenschutz text, and zero-result empty states</name>
  <files>src/app/(main)/[city]/page.tsx, src/app/(main)/datenschutz/page.tsx, src/components/search-listings-client.tsx, src/components/city-listings-client.tsx</files>
  <action>
**1. Fix `src/app/(main)/[city]/page.tsx`** — Invalid city slugs must return 404:
- Import `notFound` from "next/navigation"
- After `const city = getCityBySlug(citySlug);` add: `if (!city) notFound();`
- Remove the fallback behavior that shows all listings for unknown slugs. The `displayListings` logic should simply be `const displayListings = getCardListingsByCity(citySlug);` (no fallback to cardListings)
- Keep `generateStaticParams` unchanged — it only generates valid city slugs, so unknown slugs hit `notFound()` at request time
- The `cityName` can just be `city.name` (no null coalescing needed since we bail with notFound if city is undefined)

**2. Fix `src/app/(main)/datenschutz/page.tsx`** — Section 6 "Eingebundene Dienste Dritter":
- Replace all mentions of "OpenStreetMap" with "Mapbox"
- Change: "Unsere Website nutzt Kartenmaterial von OpenStreetMap. Beim Aufrufen einer Seite mit eingebetteter Karte wird eine Verbindung zu den Servern von OpenStreetMap hergestellt."
- To: "Unsere Website nutzt Kartenmaterial von Mapbox. Beim Aufrufen einer Seite mit eingebetteter Karte wird eine Verbindung zu den Servern von Mapbox hergestellt."
- Change: "Weitere Informationen finden Sie in der Datenschutzerklärung von OpenStreetMap."
- To: "Weitere Informationen finden Sie in der Datenschutzerklärung von Mapbox unter https://www.mapbox.com/legal/privacy."

**3. Add empty state to `src/components/search-listings-client.tsx`**:
- After the existing `{listings.length} Büros gefunden` paragraph, add a conditional:
- If `listings.length === 0`, render an empty state block instead of the grid:
  - Centered container with padding
  - Heading: "Keine Büros gefunden"
  - Text: "Versuchen Sie eine andere Stadt oder kontaktieren Sie uns für individuelle Anfragen."
  - Link to "/contact" with text "Kontakt aufnehmen" styled as a primary button
  - Link to "/" with text "Alle Städte anzeigen" styled as a text link

**4. Add empty state to `src/components/city-listings-client.tsx`**:
- If `displayListings.length === 0`, show a similar empty state instead of the listing grid:
  - Heading: "Noch keine Büros in {cityName}"
  - Text: "Wir erweitern unser Angebot stetig. Kontaktieren Sie uns und wir finden Ihr Büro."
  - Link to "/contact" with text "Kontakt aufnehmen"
  - Link to "/search" with text "Alle Büros durchsuchen"
  </action>
  <verify>
```bash
grep -q "notFound" src/app/\(main\)/\[city\]/page.tsx && echo "notFound import OK"
grep -q "Mapbox" src/app/\(main\)/datenschutz/page.tsx && ! grep -q "OpenStreetMap" src/app/\(main\)/datenschutz/page.tsx && echo "Datenschutz OK"
grep -q "Keine Büros" src/components/search-listings-client.tsx && echo "Search empty state OK"
grep -q "Noch keine Büros" src/components/city-listings-client.tsx && echo "City empty state OK"
npx tsc --noEmit
```
  </verify>
  <done>
- /asdfgh returns 404 instead of showing all listings with "Büro mieten in asdfgh" (UX-03)
- Datenschutz page section 6 references Mapbox, not OpenStreetMap (UX-05)
- Zero-result searches show a friendly empty state with CTAs (UX-10)
- TypeScript compiles with zero errors
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — zero TypeScript errors
2. `src/app/not-found.tsx` exists and contains "404" and "Startseite"
3. `src/app/(main)/error.tsx` exists with "use client" and Sentry.captureException
4. `src/app/(main)/[city]/page.tsx` calls notFound() for invalid city slugs
5. `src/app/(main)/datenschutz/page.tsx` references Mapbox, not OpenStreetMap
6. `src/components/search-listings-client.tsx` handles zero results
7. `src/components/city-listings-client.tsx` handles zero results
</verification>

<success_criteria>
- Navigating to an unknown URL shows the branded 404 page
- Navigating to /asdfgh returns 404 (not a page with all listings)
- Runtime errors in main-site pages show error boundary with retry
- Datenschutz section 6 says "Mapbox" (not "OpenStreetMap")
- Zero-result searches and empty cities show a helpful empty state
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/05-ux-and-reliability/05-01-SUMMARY.md`
</output>

---
phase: 11-server-side-event-proxy
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/REQUIREMENTS.md
autonomous: true
requirements: [SSP-01, SSP-02, SSP-03]

must_haves:
  truths:
    - "SSP-01 is verified: /api/track/event endpoint accepts event data from client"
    - "SSP-02 is verified: endpoint forwards events to GA4 Measurement Protocol server-side"
    - "SSP-03 is verified: client fires events both via gtag and via server proxy with shared event_id for deduplication"
    - "REQUIREMENTS.md checkboxes for SSP-01, SSP-02, SSP-03 are checked"
  artifacts:
    - path: "src/app/(lp)/api/track/event/route.ts"
      provides: "Server-side event proxy endpoint (SSP-01)"
      exports: ["POST"]
    - path: "src/lib/tracking/ga4-mp.ts"
      provides: "GA4 Measurement Protocol forwarding (SSP-02)"
      exports: ["sendGA4Event", "extractGA4ClientId"]
    - path: "src/app/(lp)/lp/[city]/danke/conversion-tracker.tsx"
      provides: "Dual-fire on danke page (SSP-03)"
      exports: ["ConversionTracker"]
    - path: "src/components/lp/sections/lead-form-section.tsx"
      provides: "Dual-fire on form submit (SSP-03)"
      exports: ["LeadFormSection"]
    - path: ".planning/REQUIREMENTS.md"
      provides: "Checked SSP-01/02/03 checkboxes"
      contains: "[x] **SSP-01**"
  key_links:
    - from: "src/components/lp/sections/lead-form-section.tsx"
      to: "/api/track/event"
      via: "fireServerEvent() fetch call"
      pattern: "fetch.*api/track/event"
    - from: "src/app/(lp)/lp/[city]/danke/conversion-tracker.tsx"
      to: "/api/track/event"
      via: "fetch call in useEffect"
      pattern: "fetch.*api/track/event"
    - from: "src/app/(lp)/api/track/event/route.ts"
      to: "src/lib/tracking/ga4-mp.ts"
      via: "import sendGA4Event"
      pattern: "import.*sendGA4Event.*ga4-mp"
    - from: "src/lib/tracking/ga4-mp.ts"
      to: "google-analytics.com/mp/collect"
      via: "fetch POST to GA4 Measurement Protocol"
      pattern: "google-analytics.com/mp/collect"
---

<objective>
Retroactively verify SSP-01, SSP-02, and SSP-03 requirements against existing code artifacts built during Phases 8-10, then update REQUIREMENTS.md to mark them as complete.

Purpose: These three requirements were implemented as part of other phase work but never formally verified or checked off. This plan closes the gap by examining the actual code, confirming it satisfies each requirement, and updating the tracking document.

Output: REQUIREMENTS.md with SSP-01/02/03 checked, verification evidence documented in SUMMARY.
</objective>

<execution_context>
@/Users/szymonwilkosz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/szymonwilkosz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@src/app/(lp)/api/track/event/route.ts
@src/lib/tracking/ga4-mp.ts
@src/app/(lp)/lp/[city]/danke/conversion-tracker.tsx
@src/components/lp/sections/lead-form-section.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify SSP-01/02/03 against existing code and update REQUIREMENTS.md</name>
  <files>.planning/REQUIREMENTS.md</files>
  <action>
    Verify each SSP requirement against the existing codebase. Do NOT create or modify any source code â€” this is a verification-only task.

    **SSP-01 verification:** Confirm `/api/track/event` endpoint exists at `src/app/(lp)/api/track/event/route.ts`:
    - Exports a POST handler
    - Accepts JSON body with `event_name` (string, required), `params` (object, optional), `client_id` (string, optional)
    - Validates event_name (non-empty, max 40 chars)
    - Validates params (plain object with string/number values)
    - Resolves client_id from body, _ga cookie, or crypto.randomUUID() fallback
    - Evidence: Read the route file and confirm all of the above.

    **SSP-02 verification:** Confirm GA4 Measurement Protocol forwarding exists at `src/lib/tracking/ga4-mp.ts`:
    - `sendGA4Event()` constructs a POST request to `https://www.google-analytics.com/mp/collect`
    - Uses `NEXT_PUBLIC_GA4_ID` and `GA4_MP_API_SECRET` env vars
    - Gracefully degrades when env vars are missing (returns `{ success: true, skipped: true }`)
    - Route handler (`/api/track/event`) imports and calls `sendGA4Event()` to forward events
    - Evidence: Read ga4-mp.ts and confirm the fetch call to MP endpoint.

    **SSP-03 verification:** Confirm dual-fire pattern with shared event_id in two client components:
    1. `src/components/lp/sections/lead-form-section.tsx`:
       - `fireConversionEvent()` fires gtag events with `event_id: transactionId`
       - `fireServerEvent()` fires fetch to `/api/track/event` with `event_id: transactionId` in params
       - Same `transactionId` value used in both calls (SSP-03 deduplication)
    2. `src/app/(lp)/lp/[city]/danke/conversion-tracker.tsx`:
       - `window.gtag("event", "lp_form_complete", {..., event_id: deduplicationId})`
       - `fetch("/api/track/event", {..., event_id: deduplicationId})`
       - Same `deduplicationId` value used in both calls (SSP-03 deduplication)
    - Evidence: Read both files and confirm the dual-fire pattern with shared event_id.

    **After verification passes**, update `.planning/REQUIREMENTS.md`:
    - Change `- [ ] **SSP-01**:` to `- [x] **SSP-01**:`
    - Change `- [ ] **SSP-02**:` to `- [x] **SSP-02**:`
    - Change `- [ ] **SSP-03**:` to `- [x] **SSP-03**:`
    - Update the Traceability table: change SSP-01, SSP-02, SSP-03 rows from `Pending` to `Complete`
    - Update the Coverage summary line: Satisfied count increases from 23 to 26, Pending decreases from 5 to 2 (only CAP-03, CAP-04 remain pending)
  </action>
  <verify>
    <automated>grep -c "\[x\] \*\*SSP-0" .planning/REQUIREMENTS.md | grep -q "3" && echo "PASS: All 3 SSP checkboxes checked" || echo "FAIL"</automated>
  </verify>
  <done>SSP-01, SSP-02, SSP-03 checkboxes are checked in REQUIREMENTS.md. Traceability table shows Complete status for all three. Coverage line reads "Satisfied: 26/28" and "Pending: 2/28 (CAP-03, CAP-04 Phase 13)".</done>
</task>

</tasks>

<verification>
1. `grep "\[x\] \*\*SSP-01\*\*" .planning/REQUIREMENTS.md` returns a match
2. `grep "\[x\] \*\*SSP-02\*\*" .planning/REQUIREMENTS.md` returns a match
3. `grep "\[x\] \*\*SSP-03\*\*" .planning/REQUIREMENTS.md` returns a match
4. `grep "SSP-01.*Complete" .planning/REQUIREMENTS.md` returns a match in the Traceability table
5. `grep "Satisfied: 26/28" .planning/REQUIREMENTS.md` returns a match in the Coverage section
</verification>

<success_criteria>
- All three SSP requirement checkboxes are marked [x] in REQUIREMENTS.md
- Traceability table shows Complete for SSP-01, SSP-02, SSP-03
- Coverage line reflects 26/28 satisfied, 2/28 pending
- SUMMARY documents the evidence for each verification (file paths, line references, code patterns found)
</success_criteria>

<output>
After completion, create `.planning/phases/11-server-side-event-proxy/11-01-SUMMARY.md`
</output>

---
phase: 08-visitor-utm-capture
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/middleware.ts
  - src/lib/tracking/visitor.ts
autonomous: true
requirements:
  - CAP-01
  - CAP-02

must_haves:
  truths:
    - "A first-time visitor receives an HTTP-only visitor_id cookie (UUID) on every non-API, non-static request"
    - "A return visitor keeps the same visitor_id cookie value — the middleware does NOT overwrite an existing cookie"
    - "Visiting with ?utm_source=google&utm_campaign=munich sets HTTP-only UTM cookies (_no_utm_source, _no_utm_campaign) with 30-day maxAge"
    - "UTM cookies are only written when the corresponding query parameter is present — no blank UTM cookies are set"
    - "Existing gclid/gbraid/wbraid cookie logic is preserved unchanged"
  artifacts:
    - path: "src/middleware.ts"
      provides: "Extended middleware: visitor_id UUID cookie generation + UTM parameter capture"
      contains: "visitor_id"
    - path: "src/lib/tracking/visitor.ts"
      provides: "Helper: generateVisitorId() returns crypto.randomUUID() for testability"
      contains: "generateVisitorId"
  key_links:
    - from: "src/middleware.ts"
      to: "src/lib/tracking/visitor.ts"
      via: "imports generateVisitorId"
      pattern: "generateVisitorId"
---

<objective>
Extend the existing middleware.ts to:
1. Generate a persistent visitor_id UUID cookie on first visit (CAP-01) — preserved across sessions.
2. Capture UTM parameters (utm_source, utm_medium, utm_campaign, utm_term, utm_content) into HTTP-only cookies (CAP-02).

No new API routes. No Supabase writes. Middleware only.
</objective>

<execution_context>
@/Users/szymonwilkosz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/szymonwilkosz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/middleware.ts
@src/lib/leads/validation.ts

Existing middleware behavior (MUST be preserved):
- CORS handling for /api/ routes (OPTIONS preflight + CORS headers)
- gclid, gbraid, wbraid cookies with _no_ prefix and 90-day maxAge
- Landing page (_no_lp) and referrer (_no_ref) cookies — only set when a click ID is present
- Cookie prefix: _no_ (next-office prefix)
- Matcher: all routes except _next/static, _next/image, favicon.ico

Phase 8 additions:
- visitor_id: UUID stored in _no_vid cookie, HTTP-only, secure, sameSite: lax, maxAge: 30 days (shorter than gclid's 90 days — visitor tracking is session-scoped, not ad attribution)
- UTM params: _no_utm_source, _no_utm_medium, _no_utm_campaign, _no_utm_term, _no_utm_content — HTTP-only, secure, sameSite: lax, maxAge: 30 days
- visitor_id is generated ONLY for non-API page routes (same guard as existing tracking logic)
- visitor_id is preserved on return visits: check for existing _no_vid cookie before generating a new UUID

Key decision: visitor_id uses 30-day maxAge (not 90) because visitor sessions are tracking windows, not ad attribution windows. The 90-day window is correct for gclid (Google Ads conversion window). Visitor sessions expire sooner.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create src/lib/tracking/visitor.ts helper module</name>
  <files>src/lib/tracking/visitor.ts</files>
  <action>
Create `src/lib/tracking/` directory and `src/lib/tracking/visitor.ts`.

This module provides shared constants and helpers for visitor tracking. Keeping these out of middleware.ts improves testability.

```typescript
/**
 * Visitor tracking constants and helpers.
 *
 * Extracted from middleware.ts for testability.
 * Server-safe: no browser APIs, no React.
 */

export const VISITOR_COOKIE_NAME = "_no_vid";
export const VISITOR_COOKIE_MAX_AGE = 30 * 24 * 60 * 60; // 30 days in seconds

export const UTM_COOKIE_PREFIX = "_no_utm_";
export const UTM_COOKIE_MAX_AGE = 30 * 24 * 60 * 60; // 30 days in seconds

export const UTM_KEYS = [
  "utm_source",
  "utm_medium",
  "utm_campaign",
  "utm_term",
  "utm_content",
] as const;

export type UTMKey = (typeof UTM_KEYS)[number];

/**
 * Generates a new visitor UUID.
 * Uses crypto.randomUUID() — available in Next.js Edge Runtime.
 */
export function generateVisitorId(): string {
  return crypto.randomUUID();
}
```
  </action>
  <verify>
- File exists at src/lib/tracking/visitor.ts
- Contains VISITOR_COOKIE_NAME, VISITOR_COOKIE_MAX_AGE, UTM_KEYS, and generateVisitorId exports
- Run: `grep -c "generateVisitorId\|VISITOR_COOKIE_NAME\|UTM_KEYS" src/lib/tracking/visitor.ts` — expect 3
  </verify>
  <done>
src/lib/tracking/visitor.ts exports VISITOR_COOKIE_NAME ("_no_vid"), VISITOR_COOKIE_MAX_AGE (30 days), UTM_COOKIE_PREFIX, UTM_COOKIE_MAX_AGE, UTM_KEYS array, and generateVisitorId() function.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend middleware.ts with visitor_id and UTM cookie logic</name>
  <files>src/middleware.ts</files>
  <action>
Edit `src/middleware.ts` to add visitor_id generation (CAP-01) and UTM capture (CAP-02).

**Import the new helpers at the top:**

```typescript
import {
  VISITOR_COOKIE_NAME,
  VISITOR_COOKIE_MAX_AGE,
  UTM_COOKIE_PREFIX,
  UTM_COOKIE_MAX_AGE,
  UTM_KEYS,
  generateVisitorId,
} from "@/lib/tracking/visitor";
```

**In the non-API route section (after the existing gclid/gbraid/wbraid logic), add:**

```typescript
// --- visitor_id (CAP-01) ---
// Preserve existing visitor_id on return visits. Generate a new UUID only
// when no _no_vid cookie is present (first visit).
const existingVisitorId = request.cookies.get(VISITOR_COOKIE_NAME)?.value;
if (!existingVisitorId) {
  response.cookies.set(VISITOR_COOKIE_NAME, generateVisitorId(), {
    httpOnly: true,
    secure: true,
    sameSite: "lax",
    maxAge: VISITOR_COOKIE_MAX_AGE,
    path: "/",
  });
}

// --- UTM parameters (CAP-02) ---
// Set a cookie for each UTM parameter present in the query string.
// Only sets cookies when the parameter is present — no blank cookies.
// Does NOT overwrite existing UTM cookies (first-touch attribution model):
// once a UTM cookie is set, it persists for 30 days unless a new UTM arrives.
for (const key of UTM_KEYS) {
  const value = params.get(key);
  if (value) {
    response.cookies.set(`${UTM_COOKIE_PREFIX}${key}`, value, {
      httpOnly: true,
      secure: true,
      sameSite: "lax",
      maxAge: UTM_COOKIE_MAX_AGE,
      path: "/",
    });
  }
}
```

**Placement:** Insert this block AFTER the existing `for (const key of TRACKING_KEYS)` loop (gclid handling) and BEFORE the `return response` at the end of the non-API section.

**Important:** Do NOT move or alter the existing CORS block (isApiRoute guard), the TRACKING_KEYS loop, or the hasClickId-gated lp/ref cookie logic. Only append new logic in the non-API section.

The final non-API section flow should be:
1. Create `response = NextResponse.next()`
2. Process gclid/gbraid/wbraid (existing TRACKING_KEYS loop)
3. Set _no_lp and _no_ref if hasClickId (existing logic)
4. [NEW] Set _no_vid if not already set (CAP-01)
5. [NEW] Set UTM cookies for each UTM param present in URL (CAP-02)
6. Return response
  </action>
  <verify>
- Run: `grep "VISITOR_COOKIE_NAME\|generateVisitorId" src/middleware.ts` — expect matches
- Run: `grep "_no_utm_\|UTM_KEYS\|UTM_COOKIE_PREFIX" src/middleware.ts` — expect matches
- Run: `grep "existingVisitorId" src/middleware.ts` — expect match (confirms return-visit guard)
- Confirm the CORS block for API routes is still intact: `grep "isApiRoute" src/middleware.ts`
- Confirm existing TRACKING_KEYS loop is unchanged: `grep "TRACKING_KEYS" src/middleware.ts`
- TypeScript check: `npx tsc --noEmit` — expect no errors on the modified files
  </verify>
  <done>
middleware.ts extended with:
- Import of tracking helpers from @/lib/tracking/visitor
- visitor_id cookie (_no_vid) set on first visit only (return visits preserve existing value)
- UTM cookies (_no_utm_source, _no_utm_medium, _no_utm_campaign, _no_utm_term, _no_utm_content) set when corresponding query params are present
- All existing middleware behavior (CORS, gclid/gbraid/wbraid, lp/ref cookies) unchanged
  </done>
</task>

</tasks>

<verification>
1. src/lib/tracking/visitor.ts exists with all exports
2. middleware.ts imports from @/lib/tracking/visitor
3. First-visit: _no_vid cookie is set with HTTP-only, secure, sameSite: lax, 30-day maxAge
4. Return-visit: existing _no_vid value is preserved (existingVisitorId check prevents overwrite)
5. ?utm_source=google sets _no_utm_source=google cookie
6. ?utm_campaign=munich sets _no_utm_campaign=munich cookie
7. Visiting without UTM params does NOT set blank UTM cookies
8. Existing gclid/gbraid/wbraid cookies still work as before
9. npx tsc --noEmit passes with no type errors
</verification>

<success_criteria>
- Middleware sets _no_vid (visitor_id) cookie on first visit, preserves it on return visits (CAP-01)
- Middleware captures all 5 UTM parameters into _no_utm_* cookies when present in URL (CAP-02)
- All previously working middleware behavior is unchanged
- No TypeScript errors introduced
</success_criteria>

<output>
After completion, create `.planning/phases/08-visitor-utm-capture/08-01-SUMMARY.md`
</output>

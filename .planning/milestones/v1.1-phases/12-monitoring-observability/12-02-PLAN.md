---
phase: 12-monitoring-observability
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/007_conversion_metrics_view.sql
autonomous: true
requirements:
  - MON-02

must_haves:
  truths:
    - "A Supabase view named conversion_metrics returns gclid_capture_rate (leads with non-null gclid / total leads) as a decimal between 0 and 1"
    - "The same view returns upload_success_rate (queue items with status 'uploaded' / total queue items) as a decimal between 0 and 1"
    - "The view can be queried with a simple SELECT * FROM conversion_metrics — no manual SQL joins required"
    - "The view handles edge cases: returns 0 rates when tables are empty (no division by zero)"
  artifacts:
    - path: "supabase/migrations/007_conversion_metrics_view.sql"
      provides: "SQL view for gclid capture rate and upload success rate"
      contains: "CREATE OR REPLACE VIEW conversion_metrics"
  key_links:
    - from: "supabase/migrations/007_conversion_metrics_view.sql"
      to: "supabase/migrations/005_leads_extension.sql"
      via: "reads leads table for gclid capture rate (visitor_id FK -> visitors.gclid)"
      pattern: "leads"
    - from: "supabase/migrations/007_conversion_metrics_view.sql"
      to: "supabase/migrations/003_conversion_queue.sql"
      via: "reads conversion_queue table for upload success rate"
      pattern: "conversion_queue"
---

<objective>
Create a Supabase SQL view that computes gclid capture rate and upload success rate as queryable metrics, eliminating the need for manual SQL joins.

Purpose: Operators can check conversion pipeline effectiveness with a simple `SELECT * FROM conversion_metrics` query in the Supabase dashboard -- no SQL expertise needed. The gclid capture rate shows what fraction of leads have Google Ads click attribution, and the upload success rate shows what fraction of queued conversions were successfully uploaded.
Output: 1 file -- SQL migration creating the conversion_metrics view.
</objective>

<execution_context>
@/Users/szymonwilkosz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/szymonwilkosz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@supabase/migrations/001_visitors.sql
@supabase/migrations/003_conversion_queue.sql
@supabase/migrations/005_leads_extension.sql

Key facts from prior phases and STATE.md decisions:
- leads table has visitor_id FK -> visitors table, which has gclid column
- conversion_queue table: status CHECK ('pending', 'uploaded', 'failed', 'dead_letter')
- Existing migration numbering: 001 through 006 — this is 007
- Service role bypasses RLS — views queried by service role client work on RLS-protected tables
- Text CHECK constraints over Postgres enums (established decision)
- B2B volume — tables are small, regular views (not materialized) are appropriate
- gclid lives on the visitors table (001_visitors.sql), linked to leads via visitor_id FK (005_leads_extension.sql)
- The leads table also has a direct gclid column (from v1.0 form capture) — use COALESCE to check both sources
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create conversion_metrics SQL view migration</name>
  <files>supabase/migrations/007_conversion_metrics_view.sql</files>
  <action>
Create `supabase/migrations/007_conversion_metrics_view.sql` with the following SQL:

```sql
-- Migration: 007_conversion_metrics_view
-- Purpose: Create a read-only view that computes key conversion pipeline metrics:
--          1. gclid_capture_rate: fraction of leads that have Google Ads click attribution
--          2. upload_success_rate: fraction of queued conversions successfully uploaded
--
-- These metrics answer:
--   "What % of our leads came from Google Ads clicks?" (gclid capture rate)
--   "What % of our queued conversions made it to Google Ads?" (upload success rate)
--
-- Queryable via: SELECT * FROM conversion_metrics
-- No manual SQL joins required — the view encapsulates all join logic.
--
-- Depends on: 001_visitors.sql, 003_conversion_queue.sql, 005_leads_extension.sql
--
-- Service role bypasses RLS and can query this view. The anon role cannot
-- access the underlying tables (RLS denies), so the view is effectively
-- service-role-only.

-- ---------------------------------------------------------------------------
-- View: conversion_metrics
-- ---------------------------------------------------------------------------

CREATE OR REPLACE VIEW conversion_metrics AS
SELECT
  -- GCLID capture rate: leads with gclid attribution / total leads
  -- A lead has gclid attribution if either:
  --   1. The lead's own gclid column is non-null (captured from URL params at form submission)
  --   2. The lead's linked visitor has a non-null gclid (captured by middleware)
  -- Uses COALESCE to check both sources.
  -- NULLIF prevents division by zero when no leads exist.
  COALESCE(
    CAST(
      COUNT(*) FILTER (
        WHERE l.gclid IS NOT NULL OR v.gclid IS NOT NULL
      ) AS NUMERIC
    ) / NULLIF(COUNT(*)::NUMERIC, 0),
    0
  ) AS gclid_capture_rate,

  -- Raw counts for gclid metric
  COUNT(*) FILTER (
    WHERE l.gclid IS NOT NULL OR v.gclid IS NOT NULL
  ) AS leads_with_gclid,
  COUNT(*) AS total_leads,

  -- Upload success rate: uploaded queue items / total queue items
  -- Computed as a subquery since it's from a different table (conversion_queue).
  -- NULLIF prevents division by zero when queue is empty.
  COALESCE(
    (SELECT CAST(
      COUNT(*) FILTER (WHERE cq.status = 'uploaded') AS NUMERIC
    ) / NULLIF(COUNT(*)::NUMERIC, 0)
    FROM conversion_queue cq),
    0
  ) AS upload_success_rate,

  -- Raw counts for upload metric
  (SELECT COUNT(*) FILTER (WHERE cq.status = 'uploaded') FROM conversion_queue cq) AS uploads_successful,
  (SELECT COUNT(*) FROM conversion_queue cq) AS total_queued,

  -- Queue status breakdown (bonus: useful for dashboard)
  (SELECT COUNT(*) FILTER (WHERE cq.status = 'pending') FROM conversion_queue cq) AS queue_pending,
  (SELECT COUNT(*) FILTER (WHERE cq.status = 'failed') FROM conversion_queue cq) AS queue_failed,
  (SELECT COUNT(*) FILTER (WHERE cq.status = 'dead_letter') FROM conversion_queue cq) AS queue_dead_letter,

  -- Timestamp for when this metric was computed
  now() AS computed_at

FROM leads l
LEFT JOIN visitors v ON v.id = l.visitor_id;
```

Key implementation notes:
- Regular view (not materialized) -- B2B volume means tables are small; real-time accuracy is more valuable than caching
- `COALESCE(..., 0)` ensures 0 is returned instead of NULL when tables are empty
- `NULLIF(COUNT(*)::NUMERIC, 0)` prevents division by zero
- `FILTER (WHERE ...)` syntax is Postgres-specific (available in Supabase) and cleaner than CASE WHEN for conditional aggregation
- LEFT JOIN from leads to visitors so leads without a visitor_id still count in the total
- Includes raw counts (leads_with_gclid, total_leads, uploads_successful, total_queued) alongside rates for transparency
- Queue status breakdown included as bonus context (pending, failed, dead_letter counts)
- `CREATE OR REPLACE VIEW` is idempotent -- safe to re-run
- The view inherits RLS restrictions of the underlying tables -- only service role can query it
  </action>
  <verify>
    <automated>grep -c "CREATE OR REPLACE VIEW conversion_metrics" supabase/migrations/007_conversion_metrics_view.sql && grep -c "gclid_capture_rate" supabase/migrations/007_conversion_metrics_view.sql && grep -c "upload_success_rate" supabase/migrations/007_conversion_metrics_view.sql</automated>
  </verify>
  <done>SQL migration creates conversion_metrics view returning gclid_capture_rate and upload_success_rate as decimals between 0 and 1, queryable via simple SELECT * FROM conversion_metrics</done>
</task>

</tasks>

<verification>
1. File exists: `supabase/migrations/007_conversion_metrics_view.sql`
2. Contains `CREATE OR REPLACE VIEW conversion_metrics`
3. View returns `gclid_capture_rate` as a decimal (leads with gclid / total leads)
4. View returns `upload_success_rate` as a decimal (uploaded / total queued)
5. Handles empty tables gracefully (returns 0, not NULL or error)
6. No manual SQL joins needed -- a simple `SELECT * FROM conversion_metrics` returns all metrics
</verification>

<success_criteria>
A `SELECT * FROM conversion_metrics` query returns a single row containing:
- `gclid_capture_rate`: decimal between 0 and 1 (or 0 if no leads)
- `upload_success_rate`: decimal between 0 and 1 (or 0 if no queue items)
- Raw counts: `leads_with_gclid`, `total_leads`, `uploads_successful`, `total_queued`
- Queue breakdown: `queue_pending`, `queue_failed`, `queue_dead_letter`
- `computed_at`: timestamp
</success_criteria>

<output>
After completion, create `.planning/phases/12-monitoring-observability/12-02-SUMMARY.md`
</output>

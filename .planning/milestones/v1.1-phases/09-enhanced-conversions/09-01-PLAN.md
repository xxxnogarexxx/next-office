---
phase: 09-enhanced-conversions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/lp/tracking/gtm-script.tsx
  - src/lib/tracking/hash.ts
  - src/lib/leads/service.ts
  - src/lib/leads/supabase.ts
autonomous: true
requirements:
  - EC-01
  - EC-03

must_haves:
  truths:
    - "Submitting the lead form results in a Supabase leads row where email_hash is a 64-char lowercase hex SHA-256 of the trimmed, lowercased email"
    - "The Google Ads gtag config call includes allow_enhanced_conversions: true — visible in page source or network requests"
    - "The GA4 gtag config call does NOT include allow_enhanced_conversions — only the Google Ads config line has it"
    - "A SHA-256 hash utility at src/lib/tracking/hash.ts normalizes email (trim + lowercase) before hashing, returning a 64-char lowercase hex string"
    - "handleLeadSubmission in service.ts computes email_hash from the validated email before calling insertLead"
    - "insertLead in supabase.ts writes the email_hash value to the leads table email_hash column"
    - "The email_hash column already exists from migration 005_leads_extension.sql — NO new migration is needed"
    - "Existing lead insertion behavior is unchanged — all current fields still written correctly"
  artifacts:
    - path: "src/components/lp/tracking/gtm-script.tsx"
      provides: "gtag config with allow_enhanced_conversions: true on Google Ads config"
      contains: "allow_enhanced_conversions"
    - path: "src/lib/tracking/hash.ts"
      provides: "hashEmail() utility — SHA-256 hex hash of normalized lowercase email"
      contains: "hashEmail"
    - path: "src/lib/leads/service.ts"
      provides: "Email hash computation integrated into lead pipeline before insertLead call"
      contains: "hashEmail"
    - path: "src/lib/leads/supabase.ts"
      provides: "insertLead writes email_hash to leads table"
      contains: "email_hash"
  key_links:
    - from: "src/lib/leads/service.ts"
      to: "src/lib/tracking/hash.ts"
      via: "imports hashEmail"
      pattern: "hashEmail"
    - from: "src/lib/leads/service.ts"
      to: "src/lib/leads/supabase.ts"
      via: "passes emailHash to insertLead"
      pattern: "emailHash"
---

<objective>
Enable Google Ads Enhanced Conversions at the gtag config level (EC-01) and compute + store SHA-256 hashed email on every lead submission (EC-03).

EC-01: Add `allow_enhanced_conversions: true` to the Google Ads gtag config in gtm-script.tsx.
EC-03: Create a hash utility, wire it into the lead pipeline, and store the hash in the existing email_hash column.
</objective>

<execution_context>
@/Users/szymonwilkosz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/szymonwilkosz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/lp/tracking/gtm-script.tsx
@src/lib/leads/service.ts
@src/lib/leads/supabase.ts
@src/lib/leads/validation.ts
@supabase/migrations/005_leads_extension.sql

Key facts:
- GTMScript component lives at src/components/lp/tracking/gtm-script.tsx
- It is used in BOTH (main)/layout.tsx AND (lp)/layout.tsx
- Google Ads ID env var: NEXT_PUBLIC_GOOGLE_ADS_ID
- GA4 ID env var: NEXT_PUBLIC_GA4_ID
- allow_enhanced_conversions: true goes ONLY in the Google Ads config, NOT the GA4 config
- email_hash column already exists in the leads table (migration 005, TEXT type, 64-char hex)
- idx_leads_email_hash index already exists (partial index on non-NULL email_hash)
- service.ts has the validated email (data.email) available before calling insertLead
- insertLead currently does NOT write email_hash — it must be added
- Node.js crypto module is available server-side (createHash used in src/lib/tracking/visit.ts already)
- The hash function must: trim whitespace, lowercase, then SHA-256 hex digest
- Google Enhanced Conversions spec requires SHA-256 of normalized (trimmed, lowercased) email
</context>

<tasks>

<task id="1" title="Add allow_enhanced_conversions to gtag Google Ads config">
<description>
Edit `src/components/lp/tracking/gtm-script.tsx` to add `allow_enhanced_conversions: true` to the Google Ads config call.

Current gtag init script (line ~41-49):
```typescript
__html: `
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  ${gaId ? `gtag('config', '${gaId}');` : ""}
  ${googleAdsId ? `gtag('config', '${googleAdsId}');` : ""}
`,
```

Change the Google Ads config line to:
```typescript
${googleAdsId ? `gtag('config', '${googleAdsId}', { allow_enhanced_conversions: true });` : ""}
```

IMPORTANT:
- Only the Google Ads config line gets `allow_enhanced_conversions: true`
- The GA4 config line (`gaId`) stays unchanged — GA4 does not use this setting
- Do NOT add it as a global gtag('set', ...) — it must be in the per-ID config call
- The component JSDoc should be updated to mention Enhanced Conversions (EC-01)
</description>
</task>

<task id="2" title="Create hashEmail utility at src/lib/tracking/hash.ts">
<description>
Create a new file `src/lib/tracking/hash.ts` with a `hashEmail()` function.

```typescript
/**
 * Email hashing for Google Ads Enhanced Conversions.
 *
 * Normalizes (trim + lowercase) and SHA-256 hashes the email address.
 * The result is a 64-character lowercase hex string — the format required
 * by Google Ads Enhanced Conversions for Leads (EC-03).
 *
 * Used server-side only (Node.js crypto). NOT safe for Edge Runtime.
 */

import { createHash } from "crypto";

/**
 * Compute SHA-256 hex hash of a normalized email address.
 *
 * Normalization: trim whitespace, convert to lowercase.
 * Returns a 64-character lowercase hex string.
 *
 * @param email - Raw email address (e.g., " User@Example.COM ")
 * @returns SHA-256 hex digest (e.g., "b4c9a289323b...")
 */
export function hashEmail(email: string): string {
  const normalized = email.trim().toLowerCase();
  return createHash("sha256").update(normalized).digest("hex");
}
```

This follows the same pattern as `hashIp()` in `src/lib/tracking/visit.ts` (which also uses `createHash` from Node.js crypto).
</description>
</task>

<task id="3" title="Wire email hash into service.ts and supabase.ts">
<description>
Two files need changes:

**1. src/lib/leads/service.ts** — Compute email hash after validation, pass to insertLead.

Add import at top:
```typescript
import { hashEmail } from "@/lib/tracking/hash";
```

After step 5c (UTM merge, around line 176) and before step 6 (duplicate detection), compute the email hash:

```typescript
// Step 5d: Compute SHA-256 email hash for Enhanced Conversions (EC-03).
// Google Ads uses this for cross-device attribution and offline conversion matching.
const emailHash = hashEmail(data.email);
```

Then update the insertLead call (currently line 192):
```typescript
// Before:
const insertResult = await insertLead(resolvedData, visitorUuid);

// After:
const insertResult = await insertLead(resolvedData, visitorUuid, emailHash);
```

**2. src/lib/leads/supabase.ts** — Accept emailHash parameter, write to email_hash column.

Update the `insertLead` function signature (currently line 121-123):
```typescript
// Before:
export async function insertLead(
  data: ValidatedLeadData,
  visitorUuid?: string | null
): Promise<{ success: true } | { success: false; error: string }> {

// After:
export async function insertLead(
  data: ValidatedLeadData,
  visitorUuid?: string | null,
  emailHash?: string | null
): Promise<{ success: true } | { success: false; error: string }> {
```

Add `email_hash` to the insert object (after the UTM fields, around line 150):
```typescript
// NEW: SHA-256 email hash for Enhanced Conversions (EC-03)
email_hash: emailHash ?? null,
```

The column already exists from migration 005 — no schema change needed.
</description>
</task>

</tasks>

<verification>
After execution, verify:

1. **EC-01 — gtag Enhanced Conversions config:**
   - Open `src/components/lp/tracking/gtm-script.tsx`
   - Confirm the Google Ads config line includes `{ allow_enhanced_conversions: true }`
   - Confirm the GA4 config line does NOT include this setting

2. **EC-03 — Email hash computation and storage:**
   - Open `src/lib/tracking/hash.ts` — confirm it exports `hashEmail()`
   - Confirm `hashEmail("User@Example.COM")` would produce SHA-256 of "user@example.com" (normalized)
   - Open `src/lib/leads/service.ts` — confirm `hashEmail` is imported and called with `data.email`
   - Open `src/lib/leads/supabase.ts` — confirm `insertLead` accepts `emailHash` parameter and writes to `email_hash` column
   - Confirm no new migration file was created (column already exists)

3. **Regression check:**
   - Confirm all existing fields in the insert object are preserved
   - Confirm the function signature change is backward-compatible (emailHash is optional with `?`)
</verification>

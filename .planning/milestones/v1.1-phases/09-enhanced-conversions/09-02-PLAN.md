---
phase: 09-enhanced-conversions
plan: 02
type: execute
wave: 2
depends_on:
  - 09-01-PLAN.md
files_modified:
  - supabase/migrations/006_leads_transaction_id.sql
  - src/lib/leads/validation.ts
  - src/lib/leads/supabase.ts
autonomous: true
requirements:
  - EC-04

must_haves:
  truths:
    - "The Supabase leads row stores the client-provided transaction_id (UUID) — verifiable by inserting a lead and querying the row"
    - "A new migration 006_leads_transaction_id.sql adds a transaction_id TEXT column to the leads table with a partial index"
    - "ValidatedLeadData includes transaction_id as an optional string | null field"
    - "validateLeadPayload accepts transaction_id in the request body, validates it as a string of max 36 chars, and returns it in the validated data"
    - "insertLead in supabase.ts writes data.transaction_id to the transaction_id column"
  artifacts:
    - path: "supabase/migrations/006_leads_transaction_id.sql"
      provides: "transaction_id TEXT column on leads table"
      contains: "transaction_id"
    - path: "src/lib/leads/validation.ts"
      provides: "ValidatedLeadData with transaction_id field, validated in validateLeadPayload"
      contains: "transaction_id"
    - path: "src/lib/leads/supabase.ts"
      provides: "insertLead writes transaction_id to leads table"
      contains: "transaction_id"
  key_links:
    - from: "src/lib/leads/validation.ts"
      to: "src/lib/leads/supabase.ts"
      via: "ValidatedLeadData.transaction_id flows through to insert object"
      pattern: "transaction_id"
---

<objective>
Add server-side transaction_id support: database column, validation, and Supabase write (EC-04 server half).

EC-04 (server): A transaction_id field is accepted in the lead API request body, validated, and stored in the leads table. This prepares the backend for Plan 03 which wires the client-side forms to generate and send the transaction_id.
</objective>

<execution_context>
@/Users/szymonwilkosz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/szymonwilkosz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/leads/validation.ts
@src/lib/leads/supabase.ts
@src/lib/leads/service.ts
@supabase/migrations/005_leads_extension.sql

Key facts:
- The LP form POSTs to /api/lp-leads, the main form POSTs to /api/leads — both delegate to handleLeadSubmission
- ValidatedLeadData interface in validation.ts defines all accepted fields
- After Plan 01, insertLead signature is: insertLead(data, visitorUuid, emailHash)
- The leads table has email_hash (from Plan 01) but NO transaction_id column yet
- resolvedData in service.ts spreads from `data` (ValidatedLeadData), so adding transaction_id to ValidatedLeadData automatically flows it through — no service.ts change needed
- insertLead reads fields from `data` (ValidatedLeadData) directly — no signature change needed, just add the field to the insert object
</context>

<tasks>

<task id="1" title="Add transaction_id column to leads table">
<description>
Create a new migration file `supabase/migrations/006_leads_transaction_id.sql`:

```sql
-- Migration: 006_leads_transaction_id
-- Purpose: Add transaction_id column to leads table for deduplication between
--          online gtag conversion events and offline conversion uploads (EC-04).
--
-- The transaction_id is a UUID generated client-side at form submission time.
-- It is sent to both the gtag conversion event and the lead API, enabling
-- Google Ads to deduplicate the online conversion event with the offline upload.
--
-- Depends on: 005_leads_extension.sql
-- Affects:    09-enhanced-conversions (EC-04), 10-offline-conversion (OFL-*)

ALTER TABLE leads
  ADD COLUMN IF NOT EXISTS transaction_id TEXT;  -- UUID string, 36 chars

-- Index for offline conversion matching — look up lead by transaction_id.
-- Partial index: only index rows where transaction_id is populated (v1.1+ leads).
CREATE INDEX IF NOT EXISTS idx_leads_transaction_id
  ON leads (transaction_id)
  WHERE transaction_id IS NOT NULL;
```

This follows the same pattern as migration 005 (ADD COLUMN IF NOT EXISTS for idempotency).
</description>
</task>

<task id="2" title="Extend ValidatedLeadData and validation to accept transaction_id">
<description>
Edit `src/lib/leads/validation.ts`:

**1. Add transaction_id to ValidatedLeadData interface** (after the referrer field, around line 77):
```typescript
transaction_id: string | null;
```

**2. Add transaction_id validation in validateLeadPayload** (after the referrer validation block, before the return statement around line 270):
```typescript
// --- transaction_id: optional, UUID format, max 36 chars ---
let transaction_id: string | null = null;
if (
  b.transaction_id !== undefined &&
  b.transaction_id !== null &&
  b.transaction_id !== ""
) {
  if (typeof b.transaction_id !== "string" || b.transaction_id.length > 36) {
    return { valid: false, error: "Ungültige Transaktions-ID." };
  }
  transaction_id = b.transaction_id;
}
```

**3. Add transaction_id to the return data object** (in the return statement, after `referrer`):
```typescript
transaction_id,
```
</description>
</task>

<task id="3" title="Write transaction_id to leads table in supabase.ts">
<description>
Edit `src/lib/leads/supabase.ts`:

Add `transaction_id` to the insert object in `insertLead()` (after the email_hash line added by Plan 01):
```typescript
// NEW: Shared transaction ID for gtag/offline dedup (EC-04)
transaction_id: data.transaction_id ?? null,
```

No signature change needed — `data` (ValidatedLeadData) already carries `transaction_id` after the validation.ts change in Task 2.

No changes needed in service.ts — `resolvedData` spreads from `data` which already includes `transaction_id` from validation, and `insertLead` reads `data.transaction_id` directly from the ValidatedLeadData parameter.
</description>
</task>

</tasks>

<verification>
After execution, verify:

1. **Migration:**
   - Open `supabase/migrations/006_leads_transaction_id.sql` — confirm it adds `transaction_id TEXT` column with a partial index
   - No other migration files were created or modified

2. **Validation:**
   - Open `src/lib/leads/validation.ts` — confirm `transaction_id: string | null` is in ValidatedLeadData
   - Confirm validateLeadPayload validates transaction_id (max 36 chars, string type)
   - Confirm transaction_id appears in the return data object

3. **Supabase write:**
   - Open `src/lib/leads/supabase.ts` — confirm the insert object includes `transaction_id: data.transaction_id ?? null`
   - Confirm insertLead function signature was NOT changed (no new parameter)

4. **service.ts unchanged:**
   - Confirm `src/lib/leads/service.ts` has NO changes from this plan (transaction_id flows through resolvedData automatically)

5. **Regression check:**
   - All existing fields in ValidatedLeadData and insertLead are preserved
   - insertLead signature is backward-compatible (no new parameters)
</verification>

---
phase: 07-database-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/001_visitors.sql
  - supabase/migrations/002_conversions.sql
  - supabase/migrations/003_conversion_queue.sql
  - supabase/migrations/004_tracking_events.sql
autonomous: true
requirements:
  - DB-01
  - DB-03
  - DB-04
  - DB-05

must_haves:
  truths:
    - "A visitors row can be inserted with visitor_id, gclid, UTMs, IP hash, user agent, and timestamps"
    - "A conversions row can be created with idempotency key and denormalized attribution data"
    - "A conversion_queue row tracks platform, status (pending/uploaded/failed/dead_letter), retry count, backoff timing"
    - "A tracking_events row stores event name, params, visitor reference, and timestamps"
    - "Anonymous (anon) Supabase client cannot read or write to visitors, conversions, conversion_queue, or tracking_events tables"
  artifacts:
    - path: "supabase/migrations/001_visitors.sql"
      provides: "visitors table with visitor_id PK, gclid, UTMs, IP hash, user agent, timestamps, indexes"
      contains: "CREATE TABLE"
    - path: "supabase/migrations/002_conversions.sql"
      provides: "conversions table with idempotency key, lead FK, denormalized attribution, conversion_type"
      contains: "CREATE TABLE"
    - path: "supabase/migrations/003_conversion_queue.sql"
      provides: "conversion_queue table with platform, status, retry_count, next_retry_at, dead_letter support"
      contains: "CREATE TABLE"
    - path: "supabase/migrations/004_tracking_events.sql"
      provides: "tracking_events table with event_name, params JSONB, visitor_id FK, timestamps"
      contains: "CREATE TABLE"
  key_links:
    - from: "supabase/migrations/002_conversions.sql"
      to: "leads table"
      via: "FK reference to leads(id)"
      pattern: "REFERENCES.*leads"
    - from: "supabase/migrations/003_conversion_queue.sql"
      to: "supabase/migrations/002_conversions.sql"
      via: "FK reference to conversions(id)"
      pattern: "REFERENCES.*conversions"
    - from: "supabase/migrations/004_tracking_events.sql"
      to: "supabase/migrations/001_visitors.sql"
      via: "FK reference to visitors(id)"
      pattern: "REFERENCES.*visitors"
---

<objective>
Create all new tracking tables in Supabase: visitors, conversions, conversion_queue, and tracking_events. Each table gets correct schema, indexes, FK relationships, and RLS policies that deny anonymous access.

Purpose: Establish the database foundation that Phases 8-12 will write to. No application code — schema only.
Output: 4 SQL migration files ready to run against the Supabase project.
</objective>

<execution_context>
@/Users/szymonwilkosz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/szymonwilkosz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-database-foundation/07-CONTEXT.md
@src/lib/leads/supabase.ts
@src/lib/leads/validation.ts

Key context from CONTEXT.md decisions:
- Google Ads only for v1.1 — store gclid as the only click ID column in visitors (no fbclid/msclkid)
- conversion_type values: qualified, closed
- conversion_queue statuses: pending, uploaded, failed, dead_letter
- Idempotency key format: {crm_deal_id}:{conversion_type}
- retry_count max 5, next_retry_at for backoff scheduling
- Platform column in queue for future multi-platform support
- All new tables deny anon access; service role used by API routes
- Claude's discretion: index selection, IP hash algorithm, enum vs text check constraints, tracking_events column design
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create visitors and tracking_events tables with RLS</name>
  <files>supabase/migrations/001_visitors.sql, supabase/migrations/004_tracking_events.sql</files>
  <action>
Create `supabase/migrations/` directory at project root.

**001_visitors.sql:**

Create the `visitors` table:
- `id` UUID DEFAULT gen_random_uuid() PRIMARY KEY
- `visitor_id` TEXT NOT NULL UNIQUE — the cookie-stored ID generated by middleware (Phase 8)
- `gclid` TEXT — Google Ads click ID (only click ID for v1.1, per CONTEXT decision)
- `utm_source` TEXT
- `utm_medium` TEXT
- `utm_campaign` TEXT
- `utm_term` TEXT
- `utm_content` TEXT
- `ip_hash` TEXT — SHA-256 hash of IP address (hashed for privacy, never store raw IP)
- `user_agent` TEXT
- `landing_page` TEXT — first page visited
- `referrer` TEXT — HTTP referrer
- `first_seen_at` TIMESTAMPTZ NOT NULL DEFAULT now()
- `last_seen_at` TIMESTAMPTZ NOT NULL DEFAULT now()
- `created_at` TIMESTAMPTZ NOT NULL DEFAULT now()

Indexes:
- `idx_visitors_visitor_id` ON visitors(visitor_id) — already covered by UNIQUE constraint, but add explicitly for clarity
- `idx_visitors_gclid` ON visitors(gclid) WHERE gclid IS NOT NULL — partial index, only index non-null gclids for lead matching
- `idx_visitors_last_seen_at` ON visitors(last_seen_at) — for cleanup/analytics queries

RLS:
- ALTER TABLE visitors ENABLE ROW LEVEL SECURITY;
- No policies created → anon has zero access (Supabase default with RLS enabled = deny all)
- Add a comment: "-- Service role bypasses RLS. API routes use service role for all writes."

**004_tracking_events.sql:**

Create the `tracking_events` table:
- `id` UUID DEFAULT gen_random_uuid() PRIMARY KEY
- `visitor_id` UUID REFERENCES visitors(id) ON DELETE SET NULL — nullable FK, event may outlive visitor cleanup
- `event_name` TEXT NOT NULL — e.g. 'page_view', 'generate_lead', 'form_start'
- `event_id` TEXT — for deduplication with GA4 (Phase 11 SSP-03)
- `params` JSONB DEFAULT '{}'::jsonb — flexible event parameters
- `page_url` TEXT
- `created_at` TIMESTAMPTZ NOT NULL DEFAULT now()

Indexes:
- `idx_tracking_events_visitor_id` ON tracking_events(visitor_id)
- `idx_tracking_events_event_name` ON tracking_events(event_name)
- `idx_tracking_events_created_at` ON tracking_events(created_at)

RLS:
- ALTER TABLE tracking_events ENABLE ROW LEVEL SECURITY;
- No policies → anon denied
  </action>
  <verify>
Validate SQL syntax by checking each file:
- Confirm CREATE TABLE statements have valid column definitions
- Confirm all REFERENCES point to tables/columns that exist (visitors.id exists before tracking_events references it)
- Confirm ENABLE ROW LEVEL SECURITY is present on both tables
- Run: `grep -c "ENABLE ROW LEVEL SECURITY" supabase/migrations/001_visitors.sql supabase/migrations/004_tracking_events.sql` — expect 1 each
  </verify>
  <done>
visitors table has visitor_id (UNIQUE), gclid, 5 UTM columns, ip_hash, user_agent, landing_page, referrer, timestamps, partial gclid index, and RLS enabled.
tracking_events table has event_name, event_id, params JSONB, visitor_id FK, page_url, timestamps, and RLS enabled.
Both tables deny anonymous access via RLS with no permissive policies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create conversions and conversion_queue tables with RLS</name>
  <files>supabase/migrations/002_conversions.sql, supabase/migrations/003_conversion_queue.sql</files>
  <action>
**002_conversions.sql:**

Create the `conversions` table:
- `id` UUID DEFAULT gen_random_uuid() PRIMARY KEY
- `lead_id` UUID NOT NULL REFERENCES leads(id) ON DELETE CASCADE — every conversion maps to a lead
- `conversion_type` TEXT NOT NULL CHECK (conversion_type IN ('qualified', 'closed')) — per CONTEXT decision
- `conversion_value` NUMERIC(10,2) — monetary value for Google Ads (nullable, may not always be known)
- `conversion_currency` TEXT DEFAULT 'EUR' — ISO 4217 code
- `idempotency_key` TEXT NOT NULL UNIQUE — format: {crm_deal_id}:{conversion_type} per CONTEXT decision
- `crm_deal_id` TEXT — raw CRM deal identifier for traceability
- `gclid` TEXT — denormalized from lead's visitor for upload payload (avoids JOIN at upload time)
- `email_hash` TEXT — denormalized SHA-256 hashed email for Enhanced Conversions upload
- `utm_source` TEXT — denormalized for attribution reporting
- `utm_medium` TEXT — denormalized
- `utm_campaign` TEXT — denormalized
- `created_at` TIMESTAMPTZ NOT NULL DEFAULT now()
- `updated_at` TIMESTAMPTZ NOT NULL DEFAULT now()

Indexes:
- `idx_conversions_lead_id` ON conversions(lead_id)
- `idx_conversions_idempotency_key` ON conversions(idempotency_key) — already covered by UNIQUE, explicit for clarity
- `idx_conversions_created_at` ON conversions(created_at)
- `idx_conversions_type` ON conversions(conversion_type)

RLS:
- ALTER TABLE conversions ENABLE ROW LEVEL SECURITY;
- No policies → anon denied

**003_conversion_queue.sql:**

Create the `conversion_queue` table:
- `id` UUID DEFAULT gen_random_uuid() PRIMARY KEY
- `conversion_id` UUID NOT NULL REFERENCES conversions(id) ON DELETE CASCADE
- `platform` TEXT NOT NULL DEFAULT 'google_ads' — per CONTEXT: platform column for future multi-platform
- `status` TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'uploaded', 'failed', 'dead_letter'))
- `retry_count` INTEGER NOT NULL DEFAULT 0 — max 5 per CONTEXT
- `max_retries` INTEGER NOT NULL DEFAULT 5
- `next_retry_at` TIMESTAMPTZ — null when pending (immediate), set on failure for backoff
- `last_error` TEXT — most recent error message for debugging
- `uploaded_at` TIMESTAMPTZ — when successfully uploaded to platform
- `created_at` TIMESTAMPTZ NOT NULL DEFAULT now()
- `updated_at` TIMESTAMPTZ NOT NULL DEFAULT now()

Indexes:
- `idx_queue_status_next_retry` ON conversion_queue(status, next_retry_at) WHERE status IN ('pending', 'failed') — composite partial index for cron processor query: "pick up pending and retry-ready items"
- `idx_queue_conversion_id` ON conversion_queue(conversion_id)
- `idx_queue_platform` ON conversion_queue(platform)

RLS:
- ALTER TABLE conversion_queue ENABLE ROW LEVEL SECURITY;
- No policies → anon denied
  </action>
  <verify>
Validate SQL syntax:
- Confirm CHECK constraints match expected values: conversion_type IN ('qualified','closed'), status IN ('pending','uploaded','failed','dead_letter')
- Confirm FK references: conversions.lead_id → leads(id), conversion_queue.conversion_id → conversions(id)
- Confirm RLS enabled on both tables
- Run: `grep -c "ENABLE ROW LEVEL SECURITY" supabase/migrations/002_conversions.sql supabase/migrations/003_conversion_queue.sql` — expect 1 each
- Run: `grep "CHECK" supabase/migrations/002_conversions.sql supabase/migrations/003_conversion_queue.sql` — confirm CHECK constraints present
  </verify>
  <done>
conversions table has lead_id FK, conversion_type CHECK, idempotency_key UNIQUE, denormalized gclid/email_hash/UTMs, and RLS enabled.
conversion_queue table has conversion_id FK, platform, status CHECK with 4 values, retry_count, next_retry_at, max_retries, dead_letter support, composite partial index for cron processing, and RLS enabled.
Both tables deny anonymous access.
  </done>
</task>

</tasks>

<verification>
1. All 4 SQL files exist in supabase/migrations/ with valid CREATE TABLE statements
2. Every table has ENABLE ROW LEVEL SECURITY with NO permissive policies (= anon denied)
3. FK chain: tracking_events → visitors, conversions → leads, conversion_queue → conversions
4. CHECK constraints enforce conversion_type and queue status enums
5. Partial indexes exist for high-cardinality query patterns (gclid lookup, queue processing)
6. All column types match requirements from CONTEXT.md (visitor_id, gclid only, 5 UTMs, etc.)
</verification>

<success_criteria>
- 4 SQL migration files created with no syntax errors
- visitors table matches DB-01 (visitor_id, gclid, UTMs, ip_hash, user_agent, timestamps)
- conversions table matches DB-03 (idempotency_key, denormalized attribution, conversion_type)
- conversion_queue table matches DB-04 (platform, status lifecycle, retry mechanics, dead_letter)
- tracking_events table created for Phase 11 use
- RLS enabled on all 4 tables with no anon-permissive policies (DB-05 partial)
</success_criteria>

<output>
After completion, create `.planning/phases/07-database-foundation/07-01-SUMMARY.md`
</output>

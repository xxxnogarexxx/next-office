---
phase: 03-lead-pipeline-hardening
plan: 02
type: execute
wave: 2
depends_on:
  - "03-01"
files_modified:
  - src/app/(main)/api/leads/route.ts
  - src/app/(lp)/api/lp-leads/route.ts
  - src/app/(main)/api/csrf/route.ts
  - src/components/lead-form.tsx
  - src/components/lp/sections/lead-form-section.tsx
  - src/middleware.ts
autonomous: true
requirements:
  - SEC-07
  - SEC-08
  - SEC-09
  - SEC-10
  - SEC-11
  - REL-04
  - REL-05
  - REL-06

must_haves:
  truths:
    - "A cross-origin POST to /api/leads without a valid CSRF token is rejected with 403"
    - "Submitting a lead with email 'hello' returns a validation error on both routes"
    - "Lead inserts use the anon key, not the service role key — SUPABASE_SERVICE_ROLE_KEY absent from lead route code"
    - "Submitting a duplicate lead (same phone + city within 24h) returns a deduplicated success response"
    - "The lead API response returns within 500ms regardless of email delivery latency"
    - "Both /api/leads and /api/lp-leads delegate to the shared handleLeadSubmission service"
    - "Both lead forms fetch a CSRF token on mount and include it in POST requests"
  artifacts:
    - path: "src/app/(main)/api/leads/route.ts"
      provides: "Thin route handler delegating to shared lead service"
      exports: ["POST"]
    - path: "src/app/(lp)/api/lp-leads/route.ts"
      provides: "Thin route handler delegating to shared lead service"
      exports: ["POST"]
    - path: "src/app/(main)/api/csrf/route.ts"
      provides: "CSRF token generation endpoint"
      exports: ["GET"]
    - path: "src/components/lead-form.tsx"
      provides: "Main site lead form with CSRF token integration"
    - path: "src/components/lp/sections/lead-form-section.tsx"
      provides: "LP lead form with CSRF token integration"
    - path: "src/middleware.ts"
      provides: "Updated middleware allowing /api/csrf and lead routes to handle CSRF cookies"
  key_links:
    - from: "src/app/(main)/api/leads/route.ts"
      to: "src/lib/leads/service.ts"
      via: "import handleLeadSubmission"
      pattern: "import.*handleLeadSubmission.*from.*leads/service"
    - from: "src/app/(lp)/api/lp-leads/route.ts"
      to: "src/lib/leads/service.ts"
      via: "import handleLeadSubmission"
      pattern: "import.*handleLeadSubmission.*from.*leads/service"
    - from: "src/app/(main)/api/csrf/route.ts"
      to: "src/lib/leads/service.ts"
      via: "import handleCsrfToken"
      pattern: "import.*handleCsrfToken.*from.*leads/service"
    - from: "src/components/lead-form.tsx"
      to: "/api/csrf"
      via: "fetch on mount"
      pattern: "fetch.*api/csrf"
    - from: "src/components/lp/sections/lead-form-section.tsx"
      to: "/api/csrf"
      via: "fetch on mount"
      pattern: "fetch.*api/csrf"
---

<objective>
Wire both lead API routes and both lead form components to use the shared lead service from Plan 01. Replace the duplicated route implementations with thin delegation, add CSRF token flow to forms, and create the /api/csrf endpoint.

Purpose: Complete the end-to-end lead pipeline hardening — the shared service module from Plan 01 is useless until the actual routes and forms are wired to use it. This plan makes the security and reliability improvements live.

Output: Refactored route handlers (thin wrappers), CSRF endpoint, updated form components fetching tokens, updated middleware.
</objective>

<execution_context>
@/Users/szymonwilkosz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/szymonwilkosz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-lead-pipeline-hardening/03-01-SUMMARY.md

@src/app/(main)/api/leads/route.ts
@src/app/(lp)/api/lp-leads/route.ts
@src/components/lead-form.tsx
@src/components/lp/sections/lead-form-section.tsx
@src/middleware.ts

<interfaces>
<!-- From Plan 01 outputs — the executor should verify these exist -->

From src/lib/leads/service.ts:
```typescript
export function handleLeadSubmission(request: Request, source: 'main' | 'lp'): Promise<NextResponse>;
export function handleCsrfToken(request: Request): Promise<NextResponse>;
```

From src/lib/leads/csrf.ts:
```typescript
export const CSRF_COOKIE_NAME: string; // "_no_csrf"
export function generateCsrfToken(): { token: string; cookieValue: string };
export function verifyCsrfToken(token: string | null, cookieValue: string | null): boolean;
```

From src/lib/leads/validation.ts:
```typescript
export function validateLeadPayload(body: unknown): { valid: true; data: ValidatedLeadData } | { valid: false; error: string };
export function validateEmail(email: string): boolean;
export function validateCookieValue(value: string | null | undefined): string | null;
export interface ValidatedLeadData { /* all validated fields */ };
```

Existing form patterns:
- LeadForm (main): fetches /api/leads with POST, sends JSON body, uses tracking context
- LeadFormSection (LP): fetches /api/lp-leads with POST, sends JSON body with UTM params
- Both use autoComplete="off" to prevent password managers
- CORS middleware allows same-origin and specific origins
</interfaces>

**Key decisions from prior phases:**
- Error responses use generic German messages ("Ungultige Eingabe") — avoid leaking validation details
- CORS allowlist: next-office.io + www + localhost:3000 in dev
- CSRF uses double-submit cookie pattern — token in header, HMAC in cookie
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor route files to use shared service and create CSRF endpoint</name>
  <files>
    src/app/(main)/api/leads/route.ts
    src/app/(lp)/api/lp-leads/route.ts
    src/app/(main)/api/csrf/route.ts
    src/middleware.ts
  </files>
  <action>
**Refactor /api/leads/route.ts** — Replace entire file contents with thin delegation:
```typescript
import { handleLeadSubmission } from "@/lib/leads/service";

export async function POST(request: Request) {
  return handleLeadSubmission(request, "main");
}
```
That's it. All logic is now in the shared service. The file goes from ~167 lines to ~4 lines. Remove all imports of createClient, Resend, cookies, the duplicated escapeHtml, rate limiter, etc.

**Refactor /api/lp-leads/route.ts** — Same pattern:
```typescript
import { handleLeadSubmission } from "@/lib/leads/service";

export async function POST(request: Request) {
  return handleLeadSubmission(request, "lp");
}
```
Remove all ~233 lines of duplicated logic.

**Create /api/csrf/route.ts** — New endpoint:
```typescript
import { handleCsrfToken } from "@/lib/leads/service";

export async function GET(request: Request) {
  return handleCsrfToken(request);
}
```
This endpoint:
- Generates a CSRF token pair via `handleCsrfToken`
- Sets the `_no_csrf` cookie (httpOnly, secure, sameSite: strict, path: /, maxAge: 3600)
- Returns JSON `{ token: "..." }` for the form to use in the x-csrf-token header

**Update middleware.ts** — The CORS middleware must allow the `x-csrf-token` header in preflight responses:
- In the OPTIONS preflight handler, update `Access-Control-Allow-Headers` from `"Content-Type"` to `"Content-Type, x-csrf-token"`
- This is critical — without this, browsers will reject cross-origin CSRF token headers
- Do NOT change any other middleware behavior (tracking cookies, CORS origin checks, etc.)
- Also ensure the matcher still covers `/api/csrf` (it already covers all non-static routes, so no change needed to matcher)
  </action>
  <verify>
    <automated>cd /Users/szymonwilkosz/Library/Mobile\ Documents/com~apple~CloudDocs/claude-config/projects/next-office && npx tsc --noEmit 2>&1 | head -30</automated>
  </verify>
  <done>
    - /api/leads/route.ts is ≤10 lines, imports only from @/lib/leads/service
    - /api/lp-leads/route.ts is ≤10 lines, imports only from @/lib/leads/service
    - /api/csrf/route.ts exists and exports GET handler
    - SUPABASE_SERVICE_ROLE_KEY does NOT appear in either lead route file
    - middleware.ts Access-Control-Allow-Headers includes "x-csrf-token"
    - npx tsc --noEmit passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Update lead form components with CSRF token flow</name>
  <files>
    src/components/lead-form.tsx
    src/components/lp/sections/lead-form-section.tsx
  </files>
  <action>
**Update LeadForm (src/components/lead-form.tsx):**

Add CSRF token fetching:
- Add a `csrfToken` state variable (initially `null`)
- In a `useEffect` on mount (after the existing `mounted` state is set), fetch `/api/csrf` to get the token:
  ```typescript
  useEffect(() => {
    fetch("/api/csrf", { credentials: "same-origin" })
      .then(res => res.json())
      .then(data => setCsrfToken(data.token))
      .catch(() => {}); // Silent fail — CSRF will be validated server-side, form still submittable if endpoint unreachable
  }, []);
  ```
- In the `handleSubmit` function, add the CSRF token to the fetch headers:
  ```typescript
  const res = await fetch("/api/leads", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      ...(csrfToken ? { "x-csrf-token": csrfToken } : {}),
    },
    credentials: "same-origin",  // Send cookies (including _no_csrf)
    body: JSON.stringify({ ... }),
  });
  ```
- Add `credentials: "same-origin"` to ensure the CSRF cookie is sent with the POST request
- Keep all existing form fields, validation, tracking, and UI unchanged
- Do NOT modify the form HTML structure, field names, or styling

**Update LeadFormSection (src/components/lp/sections/lead-form-section.tsx):**

Same CSRF token pattern:
- Add `csrfToken` state variable
- Fetch `/api/csrf` on mount in a useEffect
- Add `x-csrf-token` header and `credentials: "same-origin"` to the POST fetch in `handleSubmit`
- Keep all existing form fields, validation, UTM tracking, conversion event firing, and redirect behavior unchanged
- Do NOT modify the form HTML structure, field names, or styling

IMPORTANT: The CSRF fetch should NOT block form rendering. The form should render immediately and be fully interactive. The CSRF token is fetched asynchronously and attached to the submit request when available.
  </action>
  <verify>
    <automated>cd /Users/szymonwilkosz/Library/Mobile\ Documents/com~apple~CloudDocs/claude-config/projects/next-office && npx tsc --noEmit 2>&1 | head -30</automated>
  </verify>
  <done>
    - Both form components fetch /api/csrf on mount
    - Both form components include x-csrf-token header in POST requests
    - Both form components include credentials: "same-origin" in fetch calls
    - Form rendering is not blocked by CSRF token fetch
    - All existing form fields, validation, tracking, and UI behavior preserved
    - npx tsc --noEmit passes
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `grep -r "SUPABASE_SERVICE_ROLE_KEY" src/app/*/api/leads/ src/app/*/api/lp-leads/` returns no matches (service role key removed from route files)
3. `grep -r "escapeHtml" src/app/*/api/leads/ src/app/*/api/lp-leads/` returns no matches (escapeHtml consolidated to shared module)
4. `grep -c "handleLeadSubmission" src/app/\(main\)/api/leads/route.ts src/app/\(lp\)/api/lp-leads/route.ts` shows 1 match each
5. `grep "x-csrf-token" src/components/lead-form.tsx src/components/lp/sections/lead-form-section.tsx` returns matches in both files
6. `grep "credentials" src/components/lead-form.tsx src/components/lp/sections/lead-form-section.tsx` returns "same-origin" in both
7. `/api/csrf/route.ts` exists and exports a GET handler
8. `wc -l src/app/\(main\)/api/leads/route.ts` shows ~4-10 lines (thin wrapper)
</verification>

<success_criteria>
- Both lead routes delegate entirely to handleLeadSubmission — no business logic in route files
- CSRF token flow works: form fetches token on mount, sends it with POST, server validates
- Service role key is absent from lead route code — scoped anon key used instead
- Email validation rejects "hello" and "@.@" on both routes (validated by shared service)
- Duplicate leads return idempotent success (not an error)
- Email sending does not block the API response path
- All TypeScript compiles without errors
- The app builds successfully: `npm run build`
</success_criteria>

<output>
After completion, create `.planning/phases/03-lead-pipeline-hardening/03-02-SUMMARY.md`
</output>

---
phase: 02-infrastructure-foundations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/env.ts
  - .env.example
  - src/app/(main)/api/health/route.ts
  - src/app/(lp)/lp/[city]/danke/conversion-tracker.tsx
autonomous: true
requirements: [DEV-01, DEV-02, DEV-05, DEV-07]

must_haves:
  truths:
    - "Starting the app with a missing required env var logs a clear error naming the variable"
    - ".env.example exists at project root and documents every required env var"
    - "GET /api/health returns 200 with JSON confirming environment readiness"
    - "Google Ads conversion env vars are validated at runtime — placeholder patterns rejected"
  artifacts:
    - path: "src/lib/env.ts"
      provides: "Runtime env var validation module"
      exports: ["validateEnv", "env"]
    - path: ".env.example"
      provides: "Documented env var template"
      min_lines: 15
    - path: "src/app/(main)/api/health/route.ts"
      provides: "Health check API endpoint"
      exports: ["GET"]
  key_links:
    - from: "src/lib/env.ts"
      to: "process.env"
      via: "validation on import"
      pattern: "process\\.env\\."
    - from: "src/app/(main)/api/health/route.ts"
      to: "src/lib/env.ts"
      via: "import env validation"
      pattern: "import.*env"
---

<objective>
Create runtime environment validation, a documented .env.example, a health check endpoint, and Google Ads env var validation.

Purpose: The app must fail fast on misconfiguration (not silently produce broken behavior), document all required env vars for developer onboarding, expose a health endpoint for monitoring, and prevent placeholder Google Ads values from reaching production.

Output: `src/lib/env.ts`, `.env.example`, `src/app/(main)/api/health/route.ts`, updated conversion tracker
</objective>

<execution_context>
@/Users/szymonwilkosz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/szymonwilkosz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/middleware.ts
@src/app/(lp)/lp/[city]/danke/conversion-tracker.tsx
@src/lib/map-config.ts

<interfaces>
<!-- Current env var usage across the codebase (extracted via grep). Executor needs this to know every var to validate. -->

Server-side only (secret):
- process.env.NEXT_PUBLIC_SUPABASE_URL (used in both lead routes)
- process.env.SUPABASE_SERVICE_ROLE_KEY (used in both lead routes)
- process.env.RESEND_API_KEY (used in both lead routes)
- process.env.NOTIFICATION_EMAIL (used in both lead routes)

Client-side (public, NEXT_PUBLIC_ prefix):
- process.env.NEXT_PUBLIC_SUPABASE_URL (also used client-side)
- process.env.NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN (map-config.ts and LP map section)
- process.env.NEXT_PUBLIC_GA4_ID (gtm-script.tsx — optional)
- process.env.NEXT_PUBLIC_GOOGLE_ADS_ID (gtm-script.tsx — optional)
- process.env.NEXT_PUBLIC_GOOGLE_ADS_CONVERSION_ID (conversion-tracker.tsx — optional)
- process.env.NEXT_PUBLIC_GOOGLE_ADS_CONVERSION_LABEL (conversion-tracker.tsx — optional)

Files that read env vars:
- src/app/(main)/api/leads/route.ts (lines 7-8, 11, 138)
- src/app/(lp)/api/lp-leads/route.ts (lines 7-8, 11, 195)
- src/lib/map-config.ts (line 1)
- src/components/lp/tracking/gtm-script.tsx (lines 17-18)
- src/app/(lp)/lp/[city]/danke/conversion-tracker.tsx (lines 48-49)
- src/components/lp/sections/spaces-map-section.tsx (line 128)
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create runtime env validation module and .env.example</name>
  <files>src/lib/env.ts, .env.example</files>
  <action>
Create `src/lib/env.ts` that validates all required environment variables at import time.

**Implementation details:**

1. Define two categories of env vars:
   - `REQUIRED_SERVER`: `NEXT_PUBLIC_SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY`, `RESEND_API_KEY`, `NOTIFICATION_EMAIL`, `NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN`
   - `OPTIONAL_PUBLIC`: `NEXT_PUBLIC_GA4_ID`, `NEXT_PUBLIC_GOOGLE_ADS_ID`, `NEXT_PUBLIC_GOOGLE_ADS_CONVERSION_ID`, `NEXT_PUBLIC_GOOGLE_ADS_CONVERSION_LABEL`

2. Export a `validateEnv()` function that:
   - Iterates REQUIRED_SERVER vars and collects any that are undefined or empty string
   - If any missing, throws an Error with message: `Missing required environment variables:\n- VAR_NAME_1\n- VAR_NAME_2\nSee .env.example for documentation.`
   - Returns a typed object with all validated env vars

3. Export a `validateGoogleAdsEnv()` function that:
   - For each Google Ads env var that IS set, checks if the value matches placeholder patterns: `/^[X]+$/, /^AW-X+$/, /XXXXXXXXXX/, /example/i, /placeholder/i, /test/i`
   - If any match, logs `console.warn(\`[env] ${varName} appears to be a placeholder value: "${value}". Set real values or remove.\`)`
   - This is a warning, not an error — Google Ads vars are optional

4. Export `const env = validateEnv()` at module level so importing the module triggers validation.

5. At the bottom, call `validateGoogleAdsEnv()` so placeholder warnings appear on startup.

**Do NOT use any external validation libraries (zod, joi, etc.)** — keep it zero-dependency, plain TypeScript.

Create `.env.example` at project root documenting every env var:

```
# ===========================================
# next-office.io Environment Variables
# ===========================================
# Copy to .env.local and fill in real values.
# See: https://next-office.io docs or ask the team.

# --- Required (app will not start without these) ---

# Supabase project URL (public, appears in client bundle)
NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co

# Supabase service role key (SECRET — server-side only, never expose to client)
SUPABASE_SERVICE_ROLE_KEY=eyJ...

# Resend API key for sending lead notification emails (server-side only)
RESEND_API_KEY=re_...

# Email address that receives lead notifications
NOTIFICATION_EMAIL=team@next-office.io

# Mapbox access token for map rendering (public, appears in client bundle)
NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN=pk.eyJ...

# --- Optional (features degrade gracefully without these) ---

# Google Analytics 4 measurement ID
NEXT_PUBLIC_GA4_ID=G-XXXXXXXXXX

# Google Ads account ID (for conversion tracking scripts)
NEXT_PUBLIC_GOOGLE_ADS_ID=AW-XXXXXXXXXX

# Google Ads conversion ID and label (for lead form conversion events)
NEXT_PUBLIC_GOOGLE_ADS_CONVERSION_ID=AW-XXXXXXXXXX
NEXT_PUBLIC_GOOGLE_ADS_CONVERSION_LABEL=XXXXXXXXXXXXXXXX

# --- Deployment ---

# Sentry DSN for error monitoring (added in Phase 2 Plan 03)
# SENTRY_DSN=https://...@sentry.io/...
# NEXT_PUBLIC_SENTRY_DSN=https://...@sentry.io/...
```
  </action>
  <verify>
    <automated>cd "/Users/szymonwilkosz/Library/Mobile Documents/com~apple~CloudDocs/claude-config/projects/next-office" && test -f src/lib/env.ts && test -f .env.example && npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>src/lib/env.ts exports validateEnv and env, .env.example documents all required and optional env vars, TypeScript compiles cleanly</done>
</task>

<task type="auto">
  <name>Task 2: Create health check endpoint and add Google Ads env validation to conversion tracker</name>
  <files>src/app/(main)/api/health/route.ts, src/app/(lp)/lp/[city]/danke/conversion-tracker.tsx</files>
  <action>
**Health check endpoint:**

Create `src/app/(main)/api/health/route.ts` with a GET handler that:

1. Checks environment readiness by testing each required env var is set (not empty):
   - `NEXT_PUBLIC_SUPABASE_URL`
   - `SUPABASE_SERVICE_ROLE_KEY`
   - `RESEND_API_KEY`
   - `NOTIFICATION_EMAIL`
   - `NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN`

2. Returns `NextResponse.json()` with status 200 and body:
```json
{
  "status": "ok",
  "timestamp": "2026-02-26T12:00:00.000Z",
  "environment": {
    "supabase": true,
    "resend": true,
    "mapbox": true,
    "notification_email": true
  }
}
```

3. If ANY required var is missing, still return 200 but with `"status": "degraded"` and the missing service marked as `false`. Do NOT return env var values — only boolean presence checks.

4. Add `export const dynamic = "force-dynamic"` to prevent caching.

**Google Ads placeholder validation in conversion tracker:**

Update `src/app/(lp)/lp/[city]/danke/conversion-tracker.tsx`:
- After reading `conversionId` and `conversionLabel` (lines 48-49), add a check:
  ```typescript
  const isPlaceholder = (val: string | undefined) =>
    !val || /^[X]+$|^AW-X+$|XXXXXXXXXX|example|placeholder|test/i.test(val);
  ```
- If `isPlaceholder(conversionId) || isPlaceholder(conversionLabel)`, skip firing the Google Ads conversion (but still fire the GA4 event). This prevents sending junk conversion data to Google Ads if placeholder values are deployed.
- Log a console.warn if skipped: `console.warn("[ConversionTracker] Skipping Google Ads conversion — env vars appear to be placeholders")`
  </action>
  <verify>
    <automated>cd "/Users/szymonwilkosz/Library/Mobile Documents/com~apple~CloudDocs/claude-config/projects/next-office" && test -f src/app/\(main\)/api/health/route.ts && npx tsc --noEmit 2>&1 | head -20</automated>
  </verify>
  <done>GET /api/health returns 200 with JSON showing env readiness. Conversion tracker skips Google Ads event when env vars are placeholders.</done>
</task>

</tasks>

<verification>
1. `cat src/lib/env.ts` — contains validateEnv function checking all 5 required vars
2. `cat .env.example` — documents all required + optional vars with descriptions
3. `cat src/app/(main)/api/health/route.ts` — GET handler returns status + env checks
4. `npx tsc --noEmit` — compiles cleanly
5. `grep -c "isPlaceholder" src/app/(lp)/lp/[city]/danke/conversion-tracker.tsx` — placeholder validation exists
</verification>

<success_criteria>
- src/lib/env.ts throws on missing required env vars with clear message naming each missing var
- .env.example at project root documents all 9+ env vars with descriptions
- GET /api/health returns 200 JSON with status and env boolean checks
- Conversion tracker rejects placeholder Google Ads env values
- TypeScript compiles with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-infrastructure-foundations/02-01-SUMMARY.md`
</output>

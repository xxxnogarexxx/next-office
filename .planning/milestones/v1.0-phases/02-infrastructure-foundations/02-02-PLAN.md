---
phase: 02-infrastructure-foundations
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - next.config.ts
  - src/middleware.ts
autonomous: true
requirements: [SEC-06, QW-01, DEV-06]

must_haves:
  truths:
    - "Response headers include Content-Security-Policy, X-Frame-Options, Strict-Transport-Security, Referrer-Policy, and Permissions-Policy"
    - "X-Powered-By header is absent from all responses"
    - "Cross-origin POST to /api/leads from a disallowed origin is rejected or restricted by CORS"
  artifacts:
    - path: "next.config.ts"
      provides: "Security headers and X-Powered-By removal"
      contains: "headers"
    - path: "src/middleware.ts"
      provides: "CORS enforcement on API routes"
      contains: "Access-Control"
  key_links:
    - from: "next.config.ts"
      to: "HTTP responses"
      via: "Next.js headers() config"
      pattern: "headers.*async"
    - from: "src/middleware.ts"
      to: "API route responses"
      via: "CORS headers on /api/ routes"
      pattern: "Access-Control-Allow-Origin"
---

<objective>
Add security headers (CSP, X-Frame-Options, HSTS, Referrer-Policy), remove X-Powered-By, and enforce CORS on API routes.

Purpose: Protect the site from clickjacking, XSS via missing CSP, information leakage (X-Powered-By), and cross-origin API abuse. These are standard security baselines for production web applications.

Output: Updated `next.config.ts` with security headers, updated `src/middleware.ts` with CORS enforcement
</objective>

<execution_context>
@/Users/szymonwilkosz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/szymonwilkosz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@next.config.ts
@src/middleware.ts

<interfaces>
<!-- Current next.config.ts structure -->
From next.config.ts:
```typescript
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  images: {
    remotePatterns: [
      { protocol: "https", hostname: "images.unsplash.com" },
      { protocol: "https", hostname: "images.ctfassets.net" },
    ],
  },
};

export default nextConfig;
```

<!-- Current middleware.ts exports -->
From src/middleware.ts:
```typescript
export function middleware(request: NextRequest): NextResponse
export const config = {
  matcher: ["/((?!_next/static|_next/image|favicon.ico|api/).*)"],
};
```
Note: Current matcher EXCLUDES api/ routes. CORS middleware must handle api/ routes.

<!-- External domains that CSP must allow -->
Required CSP domains:
- script-src: 'self', 'unsafe-inline' (for Next.js), 'unsafe-eval' (for dev), https://www.googletagmanager.com, https://www.google-analytics.com, https://googleads.g.doubleclick.net
- style-src: 'self', 'unsafe-inline' (Tailwind + mapbox-gl inline styles)
- img-src: 'self', data:, blob:, https://images.unsplash.com, https://images.ctfassets.net, https://api.mapbox.com, https://www.google-analytics.com, https://www.googletagmanager.com
- connect-src: 'self', https://*.supabase.co, https://api.mapbox.com, https://tiles.mapbox.com, https://events.mapbox.com, https://overpass-api.de, https://www.google-analytics.com, https://googleads.g.doubleclick.net, https://region1.google-analytics.com
- font-src: 'self', https://fonts.gstatic.com
- worker-src: 'self', blob: (mapbox-gl workers)
- frame-src: 'self' (no iframes needed)
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add security headers and remove X-Powered-By in next.config.ts</name>
  <files>next.config.ts</files>
  <action>
Update `next.config.ts` to:

1. **Remove X-Powered-By** by adding `poweredByHeader: false` to the config.

2. **Add security headers** via the `headers()` async function. Apply headers to ALL routes (`source: "/(.*)"`) with:

```typescript
headers: async () => [
  {
    source: "/(.*)",
    headers: [
      {
        key: "Content-Security-Policy",
        value: [
          "default-src 'self'",
          "script-src 'self' 'unsafe-inline' 'unsafe-eval' https://www.googletagmanager.com https://www.google-analytics.com https://googleads.g.doubleclick.net",
          "style-src 'self' 'unsafe-inline'",
          "img-src 'self' data: blob: https://images.unsplash.com https://images.ctfassets.net https://api.mapbox.com https://www.google-analytics.com https://www.googletagmanager.com",
          "connect-src 'self' https://*.supabase.co https://api.mapbox.com https://tiles.mapbox.com https://events.mapbox.com https://overpass-api.de https://www.google-analytics.com https://googleads.g.doubleclick.net https://region1.google-analytics.com",
          "font-src 'self' https://fonts.gstatic.com",
          "worker-src 'self' blob:",
          "frame-src 'self'",
          "object-src 'none'",
          "base-uri 'self'",
          "form-action 'self'",
        ].join("; "),
      },
      {
        key: "X-Frame-Options",
        value: "DENY",
      },
      {
        key: "Strict-Transport-Security",
        value: "max-age=63072000; includeSubDomains; preload",
      },
      {
        key: "Referrer-Policy",
        value: "strict-origin-when-cross-origin",
      },
      {
        key: "X-Content-Type-Options",
        value: "nosniff",
      },
      {
        key: "Permissions-Policy",
        value: "camera=(), microphone=(), geolocation=(self), interest-cohort=()",
      },
    ],
  },
],
```

**Important CSP notes:**
- `'unsafe-inline'` for script-src is required because Next.js injects inline scripts for hydration. This is a known limitation.
- `'unsafe-eval'` is required for dev mode (Next.js hot reload). In production, Next.js strips eval usage, but the header still needs it to avoid console errors during development. Consider removing in production-only override later.
- `blob:` for worker-src is required by Mapbox GL (web workers for tile rendering).
- `object-src 'none'` and `base-uri 'self'` prevent Flash/plugin attacks and base-tag injection.

Keep the existing `images` config intact. Just add `poweredByHeader` and `headers` to the config object.
  </action>
  <verify>
    <automated>cd "/Users/szymonwilkosz/Library/Mobile Documents/com~apple~CloudDocs/claude-config/projects/next-office" && npx tsc --noEmit 2>&1 | head -20 && grep -c "poweredByHeader" next.config.ts && grep -c "Content-Security-Policy" next.config.ts && grep -c "X-Frame-Options" next.config.ts</automated>
  </verify>
  <done>next.config.ts has poweredByHeader: false, CSP with all required domains, X-Frame-Options DENY, HSTS with preload, Referrer-Policy, X-Content-Type-Options, Permissions-Policy. TypeScript compiles.</done>
</task>

<task type="auto">
  <name>Task 2: Add CORS enforcement to middleware for API routes</name>
  <files>src/middleware.ts</files>
  <action>
Update `src/middleware.ts` to handle CORS for API routes.

**Current state:** The middleware matcher EXCLUDES `/api/` routes. CORS must apply TO api routes.

**Implementation:**

1. Update the matcher to include API routes:
```typescript
export const config = {
  matcher: [
    // Page routes (existing — tracking cookies)
    "/((?!_next/static|_next/image|favicon.ico).*)",
  ],
};
```
This broader matcher now captures both page routes AND api routes.

2. At the top of the `middleware()` function, detect if the request is for an API route:
```typescript
const isApiRoute = request.nextUrl.pathname.startsWith("/api/");
```

3. Define allowed origins:
```typescript
const ALLOWED_ORIGINS = [
  "https://next-office.io",
  "https://www.next-office.io",
];
// In development, also allow localhost
if (process.env.NODE_ENV === "development") {
  ALLOWED_ORIGINS.push("http://localhost:3000");
}
```
Define `ALLOWED_ORIGINS` as a `const` array at module level (outside the function), with the dev check using `process.env.NODE_ENV`.

4. For API routes, add CORS handling:
```typescript
if (isApiRoute) {
  const origin = request.headers.get("origin");

  // Handle preflight OPTIONS requests
  if (request.method === "OPTIONS") {
    const preflightResponse = new NextResponse(null, { status: 204 });
    if (origin && ALLOWED_ORIGINS.includes(origin)) {
      preflightResponse.headers.set("Access-Control-Allow-Origin", origin);
    }
    preflightResponse.headers.set("Access-Control-Allow-Methods", "GET, POST, OPTIONS");
    preflightResponse.headers.set("Access-Control-Allow-Headers", "Content-Type");
    preflightResponse.headers.set("Access-Control-Max-Age", "86400");
    return preflightResponse;
  }

  // For actual requests, set CORS header if origin is allowed
  const response = NextResponse.next();
  if (origin && ALLOWED_ORIGINS.includes(origin)) {
    response.headers.set("Access-Control-Allow-Origin", origin);
  }
  return response;
}
```

5. The existing tracking cookie logic runs for non-API routes (unchanged). Wrap the existing cookie-setting block in an `else` or just let the API check return early above.

**Key design decisions:**
- No wildcard `*` for Access-Control-Allow-Origin — explicit origin list only
- Same-origin requests (no Origin header) pass through normally — CORS only restricts cross-origin
- `OPTIONS` preflight returns 204 (no body) with max-age 86400 (1 day cache)
- Only GET and POST methods allowed (no PUT/DELETE/PATCH — not used in this app)
- Health check at /api/health is included in CORS — it's fine since it returns no sensitive data
  </action>
  <verify>
    <automated>cd "/Users/szymonwilkosz/Library/Mobile Documents/com~apple~CloudDocs/claude-config/projects/next-office" && npx tsc --noEmit 2>&1 | head -20 && grep -c "Access-Control-Allow-Origin" src/middleware.ts && grep -c "ALLOWED_ORIGINS" src/middleware.ts</automated>
  </verify>
  <done>Middleware enforces CORS on /api/ routes with explicit origin allowlist. OPTIONS preflight returns 204. Non-allowed origins get no CORS header (browser blocks). TypeScript compiles.</done>
</task>

</tasks>

<verification>
1. `grep "poweredByHeader" next.config.ts` — shows `false`
2. `grep "Content-Security-Policy" next.config.ts` — CSP header present
3. `grep "Access-Control-Allow-Origin" src/middleware.ts` — CORS enforcement present
4. `npx tsc --noEmit` — zero errors
5. Security headers cover all required: CSP, X-Frame-Options, HSTS, Referrer-Policy, Permissions-Policy, X-Content-Type-Options
</verification>

<success_criteria>
- X-Powered-By header removed via poweredByHeader: false
- CSP header includes all required external domains (Mapbox, Supabase, Google Analytics, Unsplash, Contentful)
- X-Frame-Options set to DENY
- HSTS set with includeSubDomains and preload
- Referrer-Policy set to strict-origin-when-cross-origin
- CORS on API routes restricts to next-office.io origins + localhost in dev
- TypeScript compiles with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-infrastructure-foundations/02-02-SUMMARY.md`
</output>

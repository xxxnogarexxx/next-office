---
phase: 06-seo-and-analytics
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(main)/[city]/[listing]/page.tsx
  - src/app/(main)/blog/[slug]/page.tsx
  - src/lib/blog.ts
autonomous: true
requirements:
  - SEO-05
  - QW-02
  - QW-03

must_haves:
  truths:
    - "Listing detail pages include BreadcrumbList JSON-LD — Rich Results Test shows breadcrumbs"
    - "Blog post pages include BreadcrumbList JSON-LD — Rich Results Test shows breadcrumbs"
    - "JSON-LD script tags escape </script> sequences in listing and blog data to prevent XSS"
    - "Blog Article schema includes dateModified field"
  artifacts:
    - path: "src/app/(main)/[city]/[listing]/page.tsx"
      provides: "BreadcrumbList structured data and safe JSON-LD output"
      contains: "BreadcrumbList"
    - path: "src/app/(main)/blog/[slug]/page.tsx"
      provides: "BreadcrumbList structured data and dateModified in Article schema"
      contains: "BreadcrumbList"
    - path: "src/lib/blog.ts"
      provides: "dateModified field in BlogPost interface"
      contains: "dateModified"
  key_links:
    - from: "src/app/(main)/[city]/[listing]/page.tsx"
      to: "JSON.stringify replacement"
      via: "Safe JSON-LD serialization escaping </script>"
      pattern: "replace.*u003c"
    - from: "src/app/(main)/blog/[slug]/page.tsx"
      to: "src/lib/blog.ts"
      via: "dateModified field from blog post frontmatter"
      pattern: "dateModified"
---

<objective>
Add BreadcrumbList structured data to listing and blog pages, escape </script> in JSON-LD output on both page types, and add dateModified to blog Article schema.

Purpose: Listing and blog pages lack BreadcrumbList schema (breadcrumb navigation for Google Rich Results). JSON-LD uses raw JSON.stringify which could inject </script> if data contains it (XSS vector). Blog Article schema is missing dateModified.

Output: Listing and blog URLs show breadcrumbs in Rich Results. JSON-LD is XSS-safe. Blog articles include dateModified.
</objective>

<execution_context>
@/Users/szymonwilkosz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/szymonwilkosz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

<interfaces>
From src/app/(main)/[city]/[listing]/page.tsx (current JSON-LD):
```typescript
const jsonLd: Record<string, unknown> = {
  "@context": "https://schema.org",
  "@type": "LocalBusiness",
  name: listing.name,
  description: listing.description,
  // ... more fields including address, geo, priceRange
};
// Rendered as:
// <script type="application/ld+json"
//   dangerouslySetInnerHTML={{ __html: JSON.stringify(jsonLd) }}
// />
// PROBLEM: JSON.stringify does NOT escape </script> — XSS vector
// Variables available: citySlug, listingSlug, listing (full Listing object)
```

From src/app/(main)/blog/[slug]/page.tsx (current JSON-LD):
```typescript
const jsonLd = {
  "@context": "https://schema.org",
  "@type": "Article",
  headline: post.title,
  description: post.excerpt,
  image: post.coverImage,
  datePublished: post.date,
  // MISSING: dateModified
  author: { "@type": "Organization", name: post.author },
  publisher: { "@type": "Organization", name: "NextOffice", url: "https://next-office.io" },
};
// Also uses raw JSON.stringify — same escaping issue
// Variable available: slug (string), post (BlogPost)
```

From src/lib/blog.ts (current):
```typescript
export interface BlogPost {
  slug: string;
  title: string;
  excerpt: string;
  coverImage: string;
  date: string;       // datePublished
  // MISSING: dateModified
  author: string;
  category: string;
  readingTime: number;
  content: string;
}

// getAllPosts reads frontmatter via gray-matter
// getPostBySlug returns single post by slug
```

From blog frontmatter (e.g., buero-mieten-berlin.md):
```yaml
title: "Büro mieten in Berlin: Der ultimative Guide 2026"
date: "2026-02-01"
# No dateModified field in frontmatter — use date as fallback
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add BreadcrumbList and safe JSON-LD to listing detail pages</name>
  <files>src/app/(main)/[city]/[listing]/page.tsx</files>
  <action>
1. In the existing JSON-LD rendering (around line 182-185), replace:
   ```typescript
   dangerouslySetInnerHTML={{ __html: JSON.stringify(jsonLd) }}
   ```
   with:
   ```typescript
   dangerouslySetInnerHTML={{ __html: JSON.stringify(jsonLd).replace(/</g, "\\u003c") }}
   ```
   This escapes all `<` characters in the JSON output, preventing `</script>` injection (QW-02). The `\u003c` Unicode escape is valid JSON and browsers parse it correctly.

2. Add BreadcrumbList structured data. After the existing `<script type="application/ld+json">` tag for LocalBusiness, add a second script tag for BreadcrumbList:
   ```tsx
   <script
     type="application/ld+json"
     dangerouslySetInnerHTML={{
       __html: JSON.stringify({
         "@context": "https://schema.org",
         "@type": "BreadcrumbList",
         itemListElement: [
           {
             "@type": "ListItem",
             position: 1,
             name: "Startseite",
             item: "https://next-office.io",
           },
           {
             "@type": "ListItem",
             position: 2,
             name: `Büros in ${listing.city}`,
             item: `https://next-office.io/${citySlug}`,
           },
           {
             "@type": "ListItem",
             position: 3,
             name: listing.name,
             item: `https://next-office.io/${citySlug}/${listingSlug}`,
           },
         ],
       }).replace(/</g, "\\u003c"),
     }}
   />
   ```
   Place this immediately after the existing LocalBusiness JSON-LD script tag (before the `<div className="mx-auto max-w-7xl...">` container).
  </action>
  <verify>
    <automated>cd /Users/szymonwilkosz/Library/Mobile\ Documents/com~apple~CloudDocs/claude-config/projects/next-office && grep -q "BreadcrumbList" src/app/\(main\)/\[city\]/\[listing\]/page.tsx && grep -c 'replace' src/app/\(main\)/\[city\]/\[listing\]/page.tsx | grep -q "2" && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>Listing pages have BreadcrumbList JSON-LD with 3-level breadcrumb (Home > City > Listing). All JSON-LD output escapes &lt;/script&gt; sequences.</done>
</task>

<task type="auto">
  <name>Task 2: Add BreadcrumbList to blog pages, dateModified to Article schema, update BlogPost type</name>
  <files>src/app/(main)/blog/[slug]/page.tsx, src/lib/blog.ts</files>
  <action>
1. In `src/lib/blog.ts`:
   - Add optional `dateModified` field to the BlogPost interface after the `date` field:
     ```typescript
     dateModified?: string;
     ```
   - In the `getAllPosts` function, inside the posts.map callback, add dateModified to the returned object (after the `date` line):
     ```typescript
     dateModified: (data.dateModified as string | undefined) || (data.date as string),
     ```
     This reads dateModified from frontmatter if present, otherwise falls back to the publication date.

2. In `src/app/(main)/blog/[slug]/page.tsx`:
   - Add `dateModified` to the existing Article JSON-LD object. After the `datePublished: post.date,` line, add:
     ```typescript
     dateModified: post.dateModified || post.date,
     ```
   - Replace the existing JSON-LD rendering:
     ```typescript
     dangerouslySetInnerHTML={{ __html: JSON.stringify(jsonLd) }}
     ```
     with:
     ```typescript
     dangerouslySetInnerHTML={{ __html: JSON.stringify(jsonLd).replace(/</g, "\\u003c") }}
     ```
   - Add BreadcrumbList structured data. After the existing Article JSON-LD `<script>` tag, add:
     ```tsx
     <script
       type="application/ld+json"
       dangerouslySetInnerHTML={{
         __html: JSON.stringify({
           "@context": "https://schema.org",
           "@type": "BreadcrumbList",
           itemListElement: [
             {
               "@type": "ListItem",
               position: 1,
               name: "Startseite",
               item: "https://next-office.io",
             },
             {
               "@type": "ListItem",
               position: 2,
               name: "Ratgeber",
               item: "https://next-office.io/blog",
             },
             {
               "@type": "ListItem",
               position: 3,
               name: post.title,
               item: `https://next-office.io/blog/${slug}`,
             },
           ],
         }).replace(/</g, "\\u003c"),
       }}
     />
     ```
     Place this immediately after the existing Article JSON-LD script tag.
  </action>
  <verify>
    <automated>cd /Users/szymonwilkosz/Library/Mobile\ Documents/com~apple~CloudDocs/claude-config/projects/next-office && grep -q "dateModified" src/app/\(main\)/blog/\[slug\]/page.tsx && grep -q "BreadcrumbList" src/app/\(main\)/blog/\[slug\]/page.tsx && grep -q "dateModified" src/lib/blog.ts && echo "PASS" || echo "FAIL"</automated>
  </verify>
  <done>Blog Article schema includes dateModified. Blog pages have BreadcrumbList JSON-LD with 3-level breadcrumb (Home > Blog > Post). Blog JSON-LD output escapes &lt;/script&gt; sequences.</done>
</task>

</tasks>

<verification>
1. `grep "BreadcrumbList" src/app/(main)/[city]/[listing]/page.tsx` — listing pages have breadcrumbs
2. `grep "BreadcrumbList" src/app/(main)/blog/[slug]/page.tsx` — blog pages have breadcrumbs
3. `grep "u003c" src/app/(main)/[city]/[listing]/page.tsx` — listing JSON-LD escapes script tags
4. `grep "u003c" src/app/(main)/blog/[slug]/page.tsx` — blog JSON-LD escapes script tags
5. `grep "dateModified" src/app/(main)/blog/[slug]/page.tsx` — blog Article has dateModified
6. `grep "dateModified" src/lib/blog.ts` — BlogPost interface includes dateModified
7. `npx tsc --noEmit` — TypeScript compiles without errors
</verification>

<success_criteria>
- Listing detail pages include BreadcrumbList JSON-LD with 3-level breadcrumb (Home > City > Listing)
- Blog post pages include BreadcrumbList JSON-LD with 3-level breadcrumb (Home > Blog > Post)
- All JSON-LD dangerouslySetInnerHTML uses `.replace(/</g, "\\u003c")` for safe output
- Blog Article schema includes dateModified (from frontmatter or fallback to date)
- BlogPost interface in blog.ts includes optional dateModified field
- All files compile without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-seo-and-analytics/06-03-SUMMARY.md`
</output>

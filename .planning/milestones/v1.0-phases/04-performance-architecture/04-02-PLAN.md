---
phase: 04-performance-architecture
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/app/(main)/[city]/page.tsx
  - src/app/(main)/search/page.tsx
  - src/components/city-listings-client.tsx
  - src/components/search-listings-client.tsx
  - src/app/(main)/[city]/[listing]/page.tsx
  - src/app/(main)/[city]/layout.tsx
autonomous: true
requirements: [PERF-02, PERF-03]

must_haves:
  truths:
    - "curl on /berlin returns HTML containing listing card content (h1, listing names, addresses) without JavaScript execution"
    - "curl on /search returns HTML containing listing count and listing card content without JavaScript execution"
    - "City and listing pages appear as static (SSG) in Next.js build output, not server-rendered (SSR)"
    - "The client JS bundle for search/city pages does not include listings.json — only the lightweight card data is server-rendered into HTML"
    - "Map toggle, hover state, and lead dialog remain interactive (client islands)"
  artifacts:
    - path: "src/app/(main)/[city]/page.tsx"
      provides: "Server component city page that passes card listings as props"
      contains: "getCardListingsByCity"
    - path: "src/app/(main)/search/page.tsx"
      provides: "Server component search page that passes card listings as props"
      contains: "cardListings"
    - path: "src/components/city-listings-client.tsx"
      provides: "Client island for city page interactivity (map toggle, hover, CTA)"
      contains: "use client"
    - path: "src/components/search-listings-client.tsx"
      provides: "Client island for search page interactivity (map toggle, hover)"
      contains: "use client"
    - path: "src/app/(main)/[city]/[listing]/page.tsx"
      provides: "Server component with generateStaticParams"
      exports: ["generateStaticParams"]
  key_links:
    - from: "src/app/(main)/[city]/page.tsx"
      to: "src/components/city-listings-client.tsx"
      via: "server component renders client island with serialized props"
      pattern: "CityListingsClient"
    - from: "src/app/(main)/search/page.tsx"
      to: "src/components/search-listings-client.tsx"
      via: "server component renders client island with serialized props"
      pattern: "SearchListingsClient"
    - from: "src/app/(main)/[city]/[listing]/page.tsx"
      to: "generateStaticParams"
      via: "Next.js static generation"
      pattern: "generateStaticParams"
---

<objective>
Refactor city and search pages from fully client-rendered to server components with client islands, and add generateStaticParams for static generation at build time.

Purpose: Currently, the city page and search page are entirely `"use client"` — the browser downloads listings.json, parses it, and renders everything client-side. By making these server components, the HTML is pre-rendered with listing content, the client bundle shrinks dramatically, and crawlers see content without JavaScript. Adding generateStaticParams makes city and listing pages SSG (static) instead of SSR.

Output: Refactored server component pages, new client island components for interactivity, generateStaticParams on city and listing pages.
</objective>

<execution_context>
@/Users/szymonwilkosz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/szymonwilkosz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-performance-architecture/04-01-SUMMARY.md

<interfaces>
<!-- After Plan 01, these exports exist in src/lib/listings.ts -->

From src/lib/listings.ts (after Plan 01):
```typescript
export const cardListings: ListingCardType[]  // lightweight card data
export const listings: Listing[]              // full listing data (server-side only)
export function getCardListingsByCity(citySlug: string): ListingCardType[]
export function getListingsByCity(citySlug: string): Listing[]
export function getListingBySlug(slug: string): Listing | undefined
export { cities, getCityBySlug } from "./cities"
```

From src/lib/types.ts (after Plan 01):
```typescript
export interface ListingCard {
  id: string;
  name: string;
  slug: string;
  city: string;
  citySlug: string;
  address: string;
  latitude: number | null;
  longitude: number | null;
  capacityMin: number | null;
  capacityMax: number | null;
  priceFrom: number | null;
  photos: string[];
  coverPhoto: string | null;
  providerName: string | null;
}
```

From src/lib/cities.ts (after Plan 01):
```typescript
export const cities: City[]
export function getCityBySlug(slug: string): City | undefined
```

Current city page client-side state that must remain interactive:
- hoveredId (map hover highlight)
- showMap (mobile map toggle)
- formOpen (lead dialog)

Current search page client-side state:
- hoveredId (map hover highlight)
- showMap (mobile map toggle)

ListingCard component (src/components/listing-card.tsx — updated in Plan 01):
- "use client" — takes `listing: ListingCardData` prop (narrowed from Listing in Plan 01)
- onHover callback for map interaction
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor city and search pages to server components with client islands</name>
  <files>
    src/app/(main)/[city]/page.tsx
    src/app/(main)/search/page.tsx
    src/components/city-listings-client.tsx
    src/components/search-listings-client.tsx
  </files>
  <action>
    **NOTE**: Plan 01 already narrowed `src/components/listing-card.tsx` to accept the `ListingCard` type instead of `Listing`. No change to listing-card.tsx is needed here.

    **Step 1: Create `src/components/city-listings-client.tsx`** — client island for city page interactivity.
    This component receives pre-fetched card listings as props from the server component and handles all client-side state (hover, map toggle, lead dialog):
    ```typescript
    "use client";

    import { useState } from "react";
    import Image from "next/image";
    import { ListingCard } from "@/components/listing-card";
    import { SearchMap } from "@/components/search-map";
    import { LeadDialog } from "@/components/lead-dialog";
    import { Map, ArrowRight } from "lucide-react";
    import { Button } from "@/components/ui/button";
    import type { ListingCard as ListingCardData } from "@/lib/types";

    interface CityListingsClientProps {
      listings: ListingCardData[];
      cityName: string;
      citySlug: string;
      center?: { lat: number; lng: number };
    }

    const CTA_POSITION = 4;

    export function CityListingsClient({
      listings: displayListings,
      cityName,
      citySlug,
      center,
    }: CityListingsClientProps) {
      const [hoveredId, setHoveredId] = useState<string | null>(null);
      const [showMap, setShowMap] = useState(false);
      const [formOpen, setFormOpen] = useState(false);

      const firstBatch = displayListings.slice(0, CTA_POSITION);
      const restBatch = displayListings.slice(CTA_POSITION);

      return (
        // ... exact same JSX as current city page.tsx, but receiving listings via props
        // Copy the entire return JSX from current [city]/page.tsx lines 31-144
        // Replace `displayListings` references with the prop
        // The SearchMap component accepts ListingCardData[] — it only needs latitude, longitude, id, name
      );
    }
    ```
    Copy the FULL JSX from the current `[city]/page.tsx` (lines 31-144) into this component. The only change is that data comes from props instead of imports.

    **IMPORTANT for SearchMap compatibility**: The SearchMap/SearchMapInner component accepts `listings: Listing[]` in its interface. The `ListingCard` type is a subset of `Listing` that includes all fields SearchMapInner actually uses (id, name, latitude, longitude, slug, citySlug, coverPhoto, priceFrom, address, city). You may need to cast or update the SearchMap interface. Check `src/components/search-map-inner.tsx` to see which fields it uses and update the interface if needed to accept `ListingCard[]`.

    **Step 2: Create `src/components/search-listings-client.tsx`** — client island for search page:
    ```typescript
    "use client";

    import { useState } from "react";
    import { ListingCard } from "@/components/listing-card";
    import { SearchMap } from "@/components/search-map";
    import { Map } from "lucide-react";
    import { Button } from "@/components/ui/button";
    import type { ListingCard as ListingCardData } from "@/lib/types";

    interface SearchListingsClientProps {
      listings: ListingCardData[];
    }

    export function SearchListingsClient({ listings }: SearchListingsClientProps) {
      const [hoveredId, setHoveredId] = useState<string | null>(null);
      const [showMap, setShowMap] = useState(false);

      return (
        // ... exact same JSX as current search/page.tsx but receiving listings via props
      );
    }
    ```

    **Step 3: Rewrite `src/app/(main)/[city]/page.tsx`** as a server component:
    ```typescript
    import { notFound } from "next/navigation";
    import { getCityBySlug, getCardListingsByCity, cardListings } from "@/lib/listings";
    import { cities } from "@/lib/cities";
    import { CityListingsClient } from "@/components/city-listings-client";

    interface PageProps {
      params: Promise<{ city: string }>;
    }

    export function generateStaticParams() {
      return cities.map((city) => ({ city: city.slug }));
    }

    export default async function CitySearchPage({ params }: PageProps) {
      const { city: citySlug } = await params;
      const city = getCityBySlug(citySlug);
      const cityListings = getCardListingsByCity(citySlug);

      // If city not found AND no listings for this slug, show 404
      // (preserves current behavior where unknown slugs showed all listings)
      const displayListings = cityListings.length > 0 ? cityListings : cardListings;
      const cityName = city?.name ?? citySlug;

      return (
        <CityListingsClient
          listings={displayListings}
          cityName={cityName}
          citySlug={citySlug}
          center={city ? { lat: city.latitude, lng: city.longitude } : undefined}
        />
      );
    }
    ```
    Remove the `"use client"` directive. This is now a server component. The card listing data is serialized as props to the client island — it never appears in the client JS bundle.

    **NOTE on `generateStaticParams` for city pages**: This creates static pages for each city slug at build time. Since we also export `generateStaticParams` here, Next.js will statically generate these pages.

    **Step 4: Rewrite `src/app/(main)/search/page.tsx`** as a server component:
    ```typescript
    import { cardListings } from "@/lib/listings";
    import { SearchListingsClient } from "@/components/search-listings-client";

    export default function SearchPage() {
      return <SearchListingsClient listings={cardListings} />;
    }
    ```
    Remove `"use client"`. The server component passes card listings as props.

    **IMPORTANT**: The search layout.tsx already has metadata exports — do not modify it. The search page does NOT need generateStaticParams since it's a single page (not dynamic).
  </action>
  <verify>
    <automated>
      cd /Users/szymonwilkosz/Library/Mobile\ Documents/com~apple~CloudDocs/claude-config/projects/next-office && echo "--- City page ---" && head -5 src/app/\(main\)/\[city\]/page.tsx && echo "--- Search page ---" && head -5 src/app/\(main\)/search/page.tsx && echo "--- Client islands ---" && head -1 src/components/city-listings-client.tsx && head -1 src/components/search-listings-client.tsx && echo "--- generateStaticParams ---" && grep -c "generateStaticParams" src/app/\(main\)/\[city\]/page.tsx && echo "--- No 'use client' in pages ---" && grep -c "use client" src/app/\(main\)/\[city\]/page.tsx src/app/\(main\)/search/page.tsx || echo "PASS: no use client in pages"
    </automated>
  </verify>
  <done>
    - City page is a server component (no "use client") that passes card listings to CityListingsClient
    - Search page is a server component that passes card listings to SearchListingsClient
    - Client islands handle hover, map toggle, lead dialog interactivity
    - generateStaticParams on city page generates static pages for all city slugs
    - Full listings.json is never sent to the client on city or search pages
  </done>
</task>

<task type="auto">
  <name>Task 2: Add generateStaticParams to listing detail page</name>
  <files>
    src/app/(main)/[city]/[listing]/page.tsx
    src/app/(main)/[city]/layout.tsx
  </files>
  <action>
    **Step 1: Add `generateStaticParams` to `src/app/(main)/[city]/[listing]/page.tsx`.**
    This page is already a server component (no "use client"). Add the static params function:
    ```typescript
    import { listings } from "@/lib/listings";

    export function generateStaticParams() {
      return listings.map((listing) => ({
        city: listing.citySlug,
        listing: listing.slug,
      }));
    }
    ```
    Place this AFTER the existing `generateMetadata` export and BEFORE the default export function. The `listings` import is already present in this file.

    **Step 2: Verify `src/app/(main)/[city]/layout.tsx` compatibility.**
    The layout already uses `getCityBySlug` from `@/lib/listings`. After Plan 01, this function is re-exported from listings.ts via cities.ts. Verify the import still works. If the layout uses `getCityBySlug` from `@/lib/listings`, it will work because Plan 01 re-exports it. No change needed unless the import path broke.

    **IMPORTANT**: The listing detail page already uses the full `Listing` type for detail data (description, amenities, photos, etc.) — this is correct. Full listing data is needed for detail pages and it runs server-side, so it does NOT end up in the client bundle. Do NOT change it to use card data.
  </action>
  <verify>
    <automated>
      cd /Users/szymonwilkosz/Library/Mobile\ Documents/com~apple~CloudDocs/claude-config/projects/next-office && grep -c "generateStaticParams" src/app/\(main\)/\[city\]/\[listing\]/page.tsx && echo "generateStaticParams exists in listing page"
    </automated>
  </verify>
  <done>
    - Listing detail page exports generateStaticParams returning all city+listing slug combinations
    - City layout remains compatible with refactored listings module
    - Build output will show listing pages as SSG (static)
  </done>
</task>

</tasks>

<verification>
1. `grep -c "use client" src/app/\(main\)/\[city\]/page.tsx` returns 0 (server component)
2. `grep -c "use client" src/app/\(main\)/search/page.tsx` returns 0 (server component)
3. `grep -c "generateStaticParams" src/app/\(main\)/\[city\]/page.tsx` returns 1
4. `grep -c "generateStaticParams" src/app/\(main\)/\[city\]/\[listing\]/page.tsx` returns 1
5. `ls src/components/city-listings-client.tsx src/components/search-listings-client.tsx` both exist
6. Build passes: `npx next build` completes and shows city/listing pages as static
</verification>

<success_criteria>
- City and search pages are server components — HTML is pre-rendered with listing content
- Client islands handle interactivity (map, hover, dialogs) without the full listings payload
- City pages and listing detail pages use generateStaticParams for SSG
- All existing functionality is preserved — map, hover, CTA, lead dialog work correctly
</success_criteria>

<output>
After completion, create `.planning/phases/04-performance-architecture/04-02-SUMMARY.md`
</output>

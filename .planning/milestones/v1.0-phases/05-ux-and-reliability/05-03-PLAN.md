---
phase: 05-ux-and-reliability
plan: "03"
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/search-bar.tsx
  - src/components/photo-gallery.tsx
  - src/components/lead-dialog.tsx
  - src/components/search-map-inner.tsx
autonomous: false
requirements: [UX-07, UX-09, UX-12, REL-01, REL-03, SEC-12]

must_haves:
  truths:
    - "Search bar dropdown has role='listbox' and options have role='option', with aria-activedescendant tracking the selected item"
    - "Photo gallery fullscreen overlay has role='dialog', traps focus within the overlay, and locks body scroll"
    - "The custom close-button SVG in lead-dialog.tsx has aria-hidden='true' (or its parent button has an aria-label)"
    - "Listings without coordinates do not cause a JavaScript error on the map — they are filtered and a console.warn is logged in development"
    - "localStorage read/write errors in transit cache degrade gracefully to network fetch without throwing"
    - "Mapbox token is restricted to allowed URLs in the Mapbox dashboard"
  artifacts:
    - path: "src/components/search-bar.tsx"
      provides: "ARIA listbox attributes on dropdown"
      contains: "role=\"listbox\""
    - path: "src/components/photo-gallery.tsx"
      provides: "Focus trap, scroll lock, and role=dialog on fullscreen gallery"
      contains: "role=\"dialog\""
    - path: "src/components/lead-dialog.tsx"
      provides: "aria-label on close button"
      contains: "aria-label"
    - path: "src/components/search-map-inner.tsx"
      provides: "console.warn for listings missing coordinates, robust localStorage handling"
  key_links:
    - from: "src/components/photo-gallery.tsx"
      to: "document.body.style.overflow"
      via: "useEffect scroll lock when isOpen changes"
      pattern: "overflow.*hidden"
---

<objective>
Add ARIA accessibility attributes to the search bar and photo gallery, ensure decorative SVGs are screen-reader-safe, harden map reliability for listings without coordinates and localStorage failures, and restrict the Mapbox token.

Purpose: The site must be accessible to keyboard and screen reader users, the map must not break on edge cases, and the Mapbox token must be restricted before launch.

Output: 4 modified component files + 1 dashboard configuration checkpoint.
</objective>

<execution_context>
@/Users/szymonwilkosz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/szymonwilkosz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

<interfaces>
<!-- Key types and contracts the executor needs. -->

From src/components/search-bar.tsx (current state):
```typescript
// Dropdown currently has no ARIA attributes:
<div className="absolute top-full left-0 right-0 z-50 mt-1 overflow-hidden rounded-lg border bg-white shadow-lg">
  {filtered.map((city, i) => (
    <button key={city.slug} onClick={() => navigate(city.slug)}
      className={`... ${i === selectedIndex ? "bg-surface" : ""}`}>
      ...
    </button>
  ))}
</div>

// Input has no role="combobox" or aria-controls
// selectedIndex tracks keyboard selection but is not communicated to assistive tech
```

From src/components/photo-gallery.tsx (current state):
```typescript
// Fullscreen overlay has no role="dialog", no focus trap, no scroll lock:
{isOpen && (
  <div className="fixed inset-0 z-[100] overflow-y-auto bg-white">
    ...buttons for close...
    ...scrollable photo list...
  </div>
)}
// Only keyboard handler is Escape to close — no focus trap
```

From src/components/lead-dialog.tsx (current state):
```typescript
// Custom SVG close button has no aria-label:
<button onClick={() => onOpenChange(false)} className="rounded-md p-1.5 hover:bg-gray-100">
  <svg width="16" height="16" ...>...</svg>
</button>
```

From src/components/search-map-inner.tsx (current state):
```typescript
// Listings without coords already filtered at line 195-198:
const listings = allListings.filter(
  (l): l is typeof l & { latitude: number; longitude: number } =>
    l.latitude !== null && l.longitude !== null
);
// No logging of filtered-out listings

// localStorage already wrapped in try/catch (fetchCached function):
try { const raw = localStorage.getItem(cacheKey); ... } catch { /* ignore */ }
try { localStorage.setItem(cacheKey, ...); } catch { /* ignore */ }
// Already graceful — but no console.warn in development
```

Note on UX-12 (decorative icons): Lucide React already adds aria-hidden="true" to all icons
that have no children and no explicit a11y props. This is handled by the library automatically
(verified in node_modules/lucide-react/dist/esm/Icon.js line 33). The only non-Lucide
decorative element is the custom SVG close button in lead-dialog.tsx.
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ARIA to search bar, focus trap + scroll lock to photo gallery, aria-label to lead dialog close button</name>
  <files>src/components/search-bar.tsx, src/components/photo-gallery.tsx, src/components/lead-dialog.tsx</files>
  <action>
**1. Add ARIA attributes to search bar dropdown** (UX-07):

In `src/components/search-bar.tsx`:

a) On the text input (both hero and default variants), add:
  - `role="combobox"`
  - `aria-expanded={isOpen && filtered.length > 0}`
  - `aria-controls="search-city-listbox"`
  - `aria-activedescendant={selectedIndex >= 0 ? `search-city-option-${selectedIndex}` : undefined}`
  - `aria-autocomplete="list"`
  - `aria-haspopup="listbox"`

b) On the dropdown container div, add:
  - `id="search-city-listbox"`
  - `role="listbox"`
  - `aria-label="Städte"`

c) On each city button in the dropdown, change from `<button>` to `<div>` with:
  - `role="option"`
  - `id={`search-city-option-${i}`}`
  - `aria-selected={i === selectedIndex}`
  - Keep the onClick handler and styling
  - Change `<button>` to `<div>` (options in a listbox should be `role="option"`, not buttons)

**2. Add focus trap, scroll lock, and role="dialog" to photo gallery** (UX-09):

In `src/components/photo-gallery.tsx`:

a) Add `role="dialog"`, `aria-modal="true"`, and `aria-label={`Fotogalerie: ${name}`}` to the fullscreen overlay div.

b) **Scroll lock**: Add a useEffect that locks body scroll when gallery is open:
```typescript
useEffect(() => {
  if (!isOpen) return;
  const scrollY = window.scrollY;
  document.body.style.position = 'fixed';
  document.body.style.top = `-${scrollY}px`;
  document.body.style.width = '100%';
  return () => {
    document.body.style.position = '';
    document.body.style.top = '';
    document.body.style.width = '';
    window.scrollTo(0, scrollY);
  };
}, [isOpen]);
```

c) **Focus trap**: Add a useEffect that traps focus inside the gallery when open:
```typescript
useEffect(() => {
  if (!isOpen) return;
  const overlay = galleryRef.current; // Add a ref to the overlay div
  if (!overlay) return;

  const focusableSelector = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';

  function handleKeyDown(e: KeyboardEvent) {
    if (e.key === 'Escape') { setIsOpen(false); return; }
    if (e.key !== 'Tab') return;

    const focusable = overlay.querySelectorAll(focusableSelector);
    const first = focusable[0] as HTMLElement;
    const last = focusable[focusable.length - 1] as HTMLElement;

    if (e.shiftKey && document.activeElement === first) {
      e.preventDefault();
      last.focus();
    } else if (!e.shiftKey && document.activeElement === last) {
      e.preventDefault();
      first.focus();
    }
  }

  // Focus the first button on open
  const focusable = overlay.querySelectorAll(focusableSelector);
  if (focusable.length > 0) (focusable[0] as HTMLElement).focus();

  document.addEventListener('keydown', handleKeyDown);
  return () => document.removeEventListener('keydown', handleKeyDown);
}, [isOpen]);
```

d) Add `const galleryRef = useRef<HTMLDivElement>(null);` and attach it to the fullscreen overlay div.

e) Remove the existing separate Escape key handler since focus trap already handles Escape.

**3. Add aria-label to custom SVG close button in lead-dialog** (UX-12):

In `src/components/lead-dialog.tsx`:
- Add `aria-label="Schließen"` to the close button element (line ~39)
- Add `aria-hidden="true"` to the SVG element inside it

Change:
```tsx
<button onClick={() => onOpenChange(false)} className="rounded-md p-1.5 hover:bg-gray-100">
  <svg width="16" height="16" ...>...</svg>
</button>
```
To:
```tsx
<button onClick={() => onOpenChange(false)} className="rounded-md p-1.5 hover:bg-gray-100" aria-label="Schließen">
  <svg width="16" height="16" aria-hidden="true" ...>...</svg>
</button>
```
  </action>
  <verify>
```bash
grep -q 'role="listbox"' src/components/search-bar.tsx && echo "Listbox role OK"
grep -q 'aria-activedescendant' src/components/search-bar.tsx && echo "activedescendant OK"
grep -q 'role="dialog"' src/components/photo-gallery.tsx && echo "Dialog role OK"
grep -q 'aria-modal' src/components/photo-gallery.tsx && echo "aria-modal OK"
grep -q 'position.*fixed' src/components/photo-gallery.tsx && echo "Scroll lock OK"
grep -q 'aria-label="Schließen"' src/components/lead-dialog.tsx && echo "Close button label OK"
npx tsc --noEmit
```
  </verify>
  <done>
- Search dropdown has role="listbox", options have role="option", input has aria-activedescendant (UX-07)
- Photo gallery fullscreen has role="dialog", aria-modal, focus trap (Tab cycles within), and body scroll lock (UX-09)
- Custom close SVG in lead-dialog has aria-hidden="true" and its button has aria-label (UX-12)
- Lucide React icons already have automatic aria-hidden (UX-12 — no additional work needed)
- TypeScript compiles with zero errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add console.warn for listings without coordinates and verify localStorage resilience</name>
  <files>src/components/search-map-inner.tsx</files>
  <action>
**1. Add logging for listings without coordinates** (REL-01):

In `src/components/search-map-inner.tsx`, the filtering at line ~195 already excludes listings without coords from map rendering. Add a development-only console.warn:

After the filter, add:
```typescript
if (process.env.NODE_ENV === 'development') {
  const excluded = allListings.filter(l => l.latitude === null || l.longitude === null);
  if (excluded.length > 0) {
    console.warn(
      `[SearchMap] ${excluded.length} listing(s) excluded from map (missing coordinates):`,
      excluded.map(l => l.id)
    );
  }
}
```

This ensures developers can see which listings are missing coordinates without impacting production performance.

**2. Verify localStorage resilience** (REL-03):

The `fetchCached` function already wraps both `localStorage.getItem` and `localStorage.setItem` in try/catch blocks with empty catch handlers. This is correct and sufficient — if localStorage is unavailable (private browsing, quota exceeded, etc.), it degrades to a fresh network fetch.

Verify the existing code is robust:
- `localStorage.getItem` failure → falls through to network fetch
- `localStorage.setItem` failure → silently ignored, data still returned from fetch
- JSON.parse failure (corrupt cache) → caught by same try/catch, falls through to fetch

No code changes needed for REL-03 — the existing implementation is already correct. Document this finding in the summary.
  </action>
  <verify>
```bash
grep -q 'console.warn' src/components/search-map-inner.tsx && echo "Missing coords warning OK"
grep -q 'catch' src/components/search-map-inner.tsx && echo "localStorage catch OK"
npx tsc --noEmit
```
  </verify>
  <done>
- Listings without coordinates are excluded from the map with a dev-only console.warn logging their IDs (REL-01)
- localStorage failures in transit cache degrade gracefully to network fetch (REL-03 — already implemented, verified)
- TypeScript compiles with zero errors
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 3: Restrict Mapbox token to allowed URLs in dashboard</name>
  <action>
SEC-12 requires restricting the Mapbox access token to only work from allowed URLs. This is a dashboard-only action that cannot be automated via CLI.
  </action>
  <how-to-verify>
1. Go to https://account.mapbox.com/access-tokens/
2. Find the token used by next-office.io (the value of NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN)
3. Click the token to edit it
4. Under "URL restrictions", add allowed URLs:
   - `https://next-office.io/*`
   - `https://www.next-office.io/*`
   - `http://localhost:3000/*` (for local development)
5. Save the token
6. Verify the map still loads on localhost:3000 and on production

**Why this matters**: Without URL restrictions, anyone who views the page source can copy the token and use it on their own site, consuming your Mapbox quota.
  </how-to-verify>
  <resume-signal>Type "done" when Mapbox token has been restricted, or "skip" to defer to post-launch</resume-signal>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — zero TypeScript errors
2. Search bar dropdown has `role="listbox"` and `aria-activedescendant`
3. Photo gallery fullscreen has `role="dialog"`, `aria-modal="true"`, focus trap, and scroll lock
4. Lead dialog close button has `aria-label="Schließen"`
5. Console.warn fires in development for listings without coordinates
6. localStorage failures in transit cache do not throw errors
7. Mapbox token restricted in dashboard (manual verification)
</verification>

<success_criteria>
- Search bar is keyboard-accessible with proper ARIA listbox semantics
- Photo gallery fullscreen traps focus, locks body scroll, and is announced as a dialog
- All decorative icons are hidden from screen readers (Lucide automatic + manual SVG fix)
- Map handles missing-coordinate listings gracefully with logging
- localStorage failures degrade to network fetch silently
- Mapbox token restricted to production + localhost URLs
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/05-ux-and-reliability/05-03-SUMMARY.md`
</output>
